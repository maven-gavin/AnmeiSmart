# AnmeiSmart 医美智能系统

## 项目概述

AnmeiSmart是一个轻医美版的AI专家管理平台，不是AI给你看病，而是辅助咨询顾问销售转化，医生更安全的用药。它把所有的医学文献指南，案例进行汇总，顾问/医生与客户沟通情况之后，AI直接列出推荐诊疗路径，用药建议，注意事项，大量节省顾问/医生查资料的时间，提高诊疗质量，合规。整个项目功能包含人工智能客服、方案模拟、预约管理、客户关系管理等功能。

## 技术栈

- 前端: Next.js, React, TypeScript, TailwindCSS
- 后端: FastAPI, Python, PostgreSQL, MongoDB
- AI: OpenAI API
- Tauri 2.0：支持桌面和移动端
- Rust：Tauri后端逻辑
- 响应式设计：适配不同屏幕尺寸
- PWA：渐进式Web应用支持

## 实施步骤

### 第一阶段：桌面端实现

```
# 1. 安装Tauri CLI
npm install -g @tauri-apps/cli

# 2. 在项目根目录初始化Tauri
cd AnmeiSmart
mkdir desktop && cd desktop
npm create tauri-app@latest . --template vanilla-ts

# 3. 配置Tauri
```

```
// desktop/tauri.conf.json
{
  "productName": "AnmeiSmart Desktop",
  "version": "1.0.0",
  "build": {
    "frontendDist": "../web/out",
    "devUrl": "http://localhost:3000"
  },
  "app": {
    "windows": [
      {
        "title": "AnmeiSmart 医美智能系统",
        "width": 1200,
        "height": 800,
        "minWidth": 800,
        "minHeight": 600
      }
    ]
  },
  "bundle": {
    "targets": ["msi", "deb", "dmg"]
  }
}

```

### 第二阶段：移动端实现

```
# 1. 创建移动端项目
mkdir mobile && cd mobile
npm create tauri-app@latest . --template vanilla-ts

# 2. 添加移动端支持
npm run tauri android init
npm run tauri ios init
```

## 推荐实施顺序

第一步：重构现有Web代码，提取共享组件到shared/目录
第二步：实现桌面端，验证Tauri集成
第三步：适配移动端UI和交互
第四步：添加平台特定功能
第五步：完善构建和部署流程

## 运行项目

### 后端服务

```bash
cd api
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --reload
```

### 前端应用

```bash
cd web
npm install
npm run dev
```

## 项目结构

```
AnmeiSmart/
├── api/                 # 后端API服务
│   ├── app/             # 应用主目录
│   │   ├── api/         # API路由
│   │   │   ├── core/        # 核心配置
│   │   │   ├── db/          # 数据库模型和配置
│   │   │   ├── schemas/     # 数据验证模式
│   │   │   └── services/    # 业务服务
│   │   ├── migrations/      # 数据库迁移
│   │   └── tests/           # 测试
├── web/                 # 前端应用
│   │   ├── public/          # 静态资源
│   │   └── src/             # 源代码
│   │       ├── app/         # 页面组件
│   │       ├── components/  # 可复用组件
│   │       ├── contexts/    # React上下文
│   │       ├── service/     # 服务层
│   │       └── types/       # 类型定义
├── docs/                # 项目文档
├── desktop/                # 新增：Tauri桌面应用
│   │   ├── src-tauri/         # Tauri Rust后端
│   │   ├── src/               # 共享前端代码
│   │   └── tauri.conf.json    # Tauri配置
├── mobile/                 # 新增：Tauri移动应用
│   │   ├── src-tauri/         # 移动端Tauri配置
│   │   ├── src/               # 移动端适配代码
│   │   └── gen/               # 生成的移动端代码
└── shared/                 # 新增：共享组件和逻辑
    │    ├── components/        # 跨平台UI组件
    │    ├── services/          # 共享业务逻辑
    │    ├── types/             # 共享类型定义
    │    └── utils/             # 工具函数
```

## 分支管理规范

- main：主分支，始终保持可用、可部署
- dev：开发分支，集成所有feature分支，定期合并到main
- feature/xxx：功能开发分支，命名如feature/chat、feature/simulation
- hotfix/xxx：紧急修复分支
- release/xxx：预发布分支

## 协作流程

1. 从dev分支拉取最新代码，创建feature/xxx分支开发
2. 功能开发完成后提交PR（Pull Request）到dev分支，需2人以上Code Review
3. 通过测试后合并到dev，定期同步到main
4. 重要变更需在PR中详细说明，必要时同步到docs/

## 代码规范

- 前端：TS类型覆盖≥95%，组件化、严格XSS防护
- 后端：类型注解100%，禁用Any，单元测试覆盖≥80%
- 提交信息规范：feat/bugfix/docs/chore + 描述

## 其他说明

- 建议使用pnpm管理前端依赖，uv管理后端依赖
- 所有文档、设计、决策需同步到docs/

## 环境变量设置

项目使用环境变量管理配置。请参考 `api/env.example` 文件创建自己的 `.env` 文件。

主要配置项包括：

- 数据库连接配置
- JWT认证配置
- AI服务配置

详细说明请查看示例文件中的注释。

## 自动化测试说明

### 测试驱动开发方法

项目采用测试驱动开发(TDD)方法，通过以下步骤进行功能开发：

1. **编写测试用例**：首先编写测试用例，描述功能的预期行为
2. **运行测试，验证失败**：新功能尚未实现，测试应当失败
3. **实现功能代码**：编写最简单的代码使测试通过
4. **运行测试，验证通过**：确认实现的功能符合预期
5. **重构优化**：在测试通过的基础上优化代码质量，保持测试通过

主要测试用例位于 `web/src/__tests__/e2e/`目录，使用Playwright框架实现端到端测试。

### 运行测试方法

#### 自动化测试环境设置

提供了自动化脚本帮助设置测试环境：

```powershell
# 自动检查和修复测试环境
cd web
npm run test:prepare

# 或使用测试环境设置脚本
npm run test:e2e:setup

# 或手动启动
cd api
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000

# 新开一个终端
cd web
npm run dev
```

#### 运行测试命令

```powershell
# 运行所有测试
npm run test:e2e

# 只运行聊天功能测试
npm run test:e2e:chat

# 只运行基本导航测试
npm run test:e2e:basic
```

### 常见测试问题与解决方案

#### 1. API端点404错误

**问题描述**：在执行测试时，创建会话相关的API调用返回404错误。

```
尝试创建会话 /api/v1/conversations... 404 {"detail":"Not Found"}
```

**原因分析**：测试工具中使用了错误的API路径，API路由配置将聊天功能设置为 `/api/v1/chat`前缀，正确的会话创建端点应为 `/api/v1/chat/conversations`。

**解决方案**：运行 `npm run test:prepare`自动修复，或修改 `web/src/__tests__/e2e/chat/test-utils.ts`中的 `endpoints`数组，确保包含正确的端点：

```typescript
const endpoints = [
  '/api/v1/chat/conversations',  // 正确的端点
  // 其他备选端点
];
```

#### 2. WebSocket连接问题

**问题描述**：测试过程中WebSocket连接建立失败，导致实时消息无法发送或接收。

**原因分析**：WebSocket服务器URL配置错误，或后端WebSocket服务未正确启动。

**解决方案**：

1. 检查 `chatService.ts`中的WebSocket URL配置
2. 确保后端API服务已启动且包含WebSocket支持
3. 检查WebSocket连接请求中是否包含必要的认证信息

### API端点参考

以下是系统主要API端点的参考：

- `POST /api/v1/auth/login` - 用户登录 (使用表单格式提交)
- `POST /api/v1/chat/conversations` - 创建聊天会话
- `GET /api/v1/chat/conversations` - 获取会话列表
- `GET /api/v1/chat/conversations/{id}` - 获取单个会话详情
- `GET /api/v1/chat/conversations/{id}/messages` - 获取会话消息
- `POST /api/v1/chat/conversations/{id}/messages` - 发送会话消息
- `WebSocket /api/v1/chat/ws/{user_id}` - WebSocket连接端点

## 主要测试场景

### 发送普通文本消息，AI应答

## 前提

* 顾客customer1@example.com已登录
* 顾问zhang@example.com已登录
* AI接管模式（系统默认模式）
* 顾客已进入会话ID为1的聊天页面
* 顾问已进入会话ID为1的聊天页面进行监控
* 当前会话已有历史消息记录

## 业务流程

1. 顾客在聊天输入框中输入"双眼皮手术恢复时间?"
2. 顾客点击发送按钮或按下Enter键
3. 顾客端聊天窗口右侧显示该条消息，带有"我"的头像和名称标识
4. 系统将消息发送到后端服务器，消息记录保存到数据库
5. 后端服务器接收到消息后，调用Dify AI服务
6. Dify AI服务生成回复内容
7. 后端将AI回复保存到数据库，作为同一会话的一部分
8. 后端通过WebSocket将AI回复推送到前端
9. 顾客端聊天窗口左侧显示AI回复，带有"AI助手"的头像和名称标识
10. 顾问监控端同步看到顾客发送的消息和AI的回复
11. 顾客刷新页面，系统从数据库重新加载会话历史
12. 所有历史消息按时间顺序重新显示，包括顾客消息和AI回复

## 预期结果

* 顾客发送的消息正确显示在聊天窗口右侧
* 显示发送中状态指示器
* AI回复在3秒内响应并显示在聊天窗口左侧
* AI回复内容与询问相关，提供双眼皮手术恢复时间的专业信息
* 整个交互过程流畅，无卡顿
* 消息记录被正确保存到数据库，刷新页面后仍完整显示所有历史消息
* AI回复被视为顾问团队的一部分，在统一的会话流中显示

## 异常场景

* 网络连接中断：系统应显示连接错误提示，并在恢复连接后自动重新连接
* AI服务超时：系统应在10秒后显示"AI响应超时，请稍后再试"的提示
* 消息发送失败：系统应显示"消息发送失败"并提供重试选项
* 历史记录加载失败：系统应提示"加载历史记录失败"并提供重试选项

### 发送普通文本消息，顾问应答

## 前提

* 顾客customer1@example.com已登录
* 顾问zhang@example.com已登录
* 顾问已通过顾问端操作接管会话（点击了顾问接管按钮）
* 顾客已进入会话ID为1的聊天页面
* 顾问已进入会话ID为1的聊天页面
* 当前会话已包含AI回复的历史消息

## 业务流程

1. 系统向顾客显示系统消息："顾问张医生已接管会话"，该系统消息同样保存到数据库
2. 顾客在聊天输入框中输入"双眼皮手术后多久可以洗脸?"
3. 顾客点击发送按钮或按下Enter键
4. 顾客端聊天窗口右侧显示该条消息，带有"我"的头像和名称标识
5. 系统将消息发送到后端服务器并保存到数据库
6. 后端服务器接收到消息后，因处于顾问接管模式，不调用AI服务
7. 后端通过WebSocket将消息推送到顾问端
8. 顾问端聊天窗口左侧显示顾客消息，带有"李小姐"的头像和名称标识
9. 顾问在输入框中输入"您好，一般建议术后3-5天内避免沾水，一周后可以正常洗脸，但需轻柔避免按压手术部位"
10. 顾问点击发送按钮或按下Enter键
11. 顾问端聊天窗口右侧显示该条消息，带有"我"的头像和名称标识
12. 系统将顾问消息发送到后端服务器并保存到数据库，标记为顾问回复
13. 后端通过WebSocket将顾问消息推送到顾客端
14. 顾客端聊天窗口左侧显示顾问回复，带有"张医生"的头像和名称标识
15. 顾客或顾问刷新页面，系统从数据库重新加载会话历史
16. 所有历史消息按时间顺序重新显示，包括之前的AI回复和顾问回复，保持完整对话流

## 预期结果

* 接管状态正确显示，顾客可看到系统通知
* 顾客发送的消息正确显示在自己的聊天窗口右侧
* 顾问能实时看到顾客发送的消息
* 顾问回复的消息正确显示在顾客的聊天窗口左侧
* 消息记录被正确保存，刷新页面后显示完整历史，包括：
  * 之前的AI回复（显示为"AI助手"）
  * 顾问接管的系统通知
  * 顾问的回复（显示为"张医生"）
* 从顾客角度看，整个会话是连贯的，无论是AI回复还是顾问回复都是服务的一部分
* 顾问可随时通过"切换回AI助手"按钮将对话控制权归还给AI
* 当顾问切换回AI助手模式时，系统显示通知："AI助手已重新接管会话"

## 异常场景

* 网络连接中断：系统应显示连接错误提示，并在恢复连接后自动重新连接
* 顾问离线：如顾问连接断开超过5分钟，系统应提示顾客"顾问暂时离线，是否切换回AI助手？"
* 消息发送失败：系统应显示"消息发送失败"并提供重试选项
* 顾问同时接管多个会话：系统应能正确区分不同会话并独立处理
* 数据同步问题：如消息在不同端显示不一致，系统应提供刷新按钮手动同步最新状态
* 会话历史加载不完整：系统应提供加载更多历史记录的选项

### 模式切换的无缝衔接

## 前提

* 顾客customer1@example.com已登录
* 顾问zhang@example.com已登录
* 会话ID为1已有多轮AI与顾客的对话历史
* 顾问已接管过会话并回复过顾客问题
* 顾问现在准备切换回AI助手模式
* 顾客与顾问都在各自的聊天页面

## 业务流程

1. 顾问在顾问端点击"切换回AI助手"按钮
2. 系统向双方显示系统消息："AI助手已重新接管会话"，并保存到数据库
3. 系统将会话状态从"顾问接管"更改为"AI接管"
4. 顾客在聊天输入框中输入"双眼皮修复需要多长时间?"
5. 顾客点击发送按钮或按下Enter键
6. 顾客端聊天窗口右侧显示该条消息，带有"我"的头像和名称标识
7. 系统将消息发送到后端服务器并保存到数据库
8. 后端服务器接收到消息后，因已切换到AI模式，调用Dify AI服务
9. Dify AI服务访问完整会话历史（包括之前的AI回复和顾问回复）
10. Dify AI基于完整上下文生成回复内容，特别参考顾问之前提供的专业意见
11. 后端将AI回复保存到数据库
12. 后端通过WebSocket将AI回复推送到前端
13. 顾客端聊天窗口左侧显示AI回复，带有"AI助手"的头像和名称标识
14. 顾问监控端同步看到顾客发送的消息和AI的回复
15. 任何一方刷新页面，系统从数据库重新加载完整会话历史
16. 所有历史消息按时间顺序显示，包括AI回复、顾问接管通知、顾问回复、重新AI接管通知等

## 预期结果

* 模式切换状态正确显示，双方可看到系统通知
* AI能够访问并理解完整的会话历史，包括顾问参与的部分
* AI生成的回复与之前顾问提供的信息保持一致性，没有矛盾内容
* AI回复引用或参考了顾问之前提供的专业信息
* 顾客体验上是一个连贯的咨询过程，不会因模式切换而割裂
* 所有历史记录无论是哪种模式产生的，都能在数据库中正确保存并在UI中一致显示
* 刷新页面后，完整对话历史保持不变，包括模式切换的系统通知
* AI作为顾问的"数字分身"，能够与人工顾问服务形成无缝衔接

## 异常场景

* 模式切换失败：系统应显示错误提示，并维持当前模式不变
* AI服务无法访问完整历史：系统应确保至少能访问最近的会话上下文
* 历史记录中包含敏感信息：AI应能识别并避免重复或进一步讨论不适当内容
* 顾问切换回AI模式后立即离线：系统应正常处理AI回复流程，顾问可在重新上线后查看历史
* AI生成的回复与顾问之前建议存在矛盾：系统应有机制检测并调整AI回复，确保专业一致性

如有疑问请联系项目负责人或在Issue区讨论。
