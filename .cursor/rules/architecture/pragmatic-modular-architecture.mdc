---
description: 重构或创建模块时，采用实用“模块化服务架构”标准
globs: api/app/**/*.py
alwaysApply: false
---
# 实用模块化服务架构规范 (Pragmatic Modular Service Architecture)

## 核心原则
采用 **Controller-Service-Model-Schema** 的扁平化分层结构，替代复杂的 DDD 分层（如 Domain/Application/Infrastructure）。

## 目录结构标准
以模块 `module_name` 为例：
```text
api/app/module_name/
├── controllers/       # API 路由定义 (原 endpoints)
│   ├── entity_controller.py
│   └── ...
├── services/          # 业务逻辑层 (合并 Application + Domain + Repository)
│   ├── entity_service.py
│   └── ...
├── models/            # 数据库模型 (SQLAlchemy)
│   ├── entity.py
│   └── ...
├── schemas/           # 数据传输对象 (Pydantic)
│   ├── entity.py
│   └── ...
├── deps/              # 依赖注入
│   └── module_deps.py
└── enums.py           # (可选) 共享枚举
```

## 实现规范

### 1. Models (数据库模型)
- 存放于 `models/` 目录。
- 直接定义 SQLAlchemy 模型。
- **禁止**：不要再次包装为 Domain Entity。

### 2. Schemas (DTO)
- 存放于 `schemas/` 目录。
- 使用 Pydantic V2。
- 配置自动转换：
  ```python
  class UserResponse(BaseModel):
      model_config = ConfigDict(from_attributes=True)  # 允许从 ORM 对象读取
  ```
- 转换方式：使用 `UserResponse.model_validate(user_model)` 进行转换，替代手动 Converter。

### 3. Services (业务服务)
- 存放于 `services/` 目录。
- 职责：包含所有业务逻辑和数据库操作（CRUD）。
- **禁止**：不要创建独立的 Repository 层，Service 直接操作 `db: Session`。
- 示例：
  ```python
  class UserService:
      def __init__(self, db: Session):
          self.db = db
      
      def get_user(self, id: str) -> Optional[User]:
          return self.db.query(User).filter(User.id == id).first()
  ```

### 4. Controllers (控制器)
- 存放于 `controllers/` 目录。
- 职责：处理 HTTP 请求/响应，参数解析，调用 Service。
- **必须**：遵循 `docs/ERROR_HANDLING_STANDARD.md` 进行错误处理。
  - 使用 `BusinessException` 抛出业务错误。
  - 捕获异常并转换为 `SystemException`。

## 重构原则
1.  **零冗余**：删除旧的 `application`, `domain`, `infrastructure`, `interfaces`, `converters` 目录。
2.  **无向后兼容**：重构时直接修改调用方，保持代码库干净，不要保留适配层。
3.  **参考范例**：请参考 `api/app/identity_access` 模块作为最佳实践标准。
