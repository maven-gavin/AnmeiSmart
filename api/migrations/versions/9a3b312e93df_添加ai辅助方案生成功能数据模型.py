"""添加AI辅助方案生成功能数据模型

Revision ID: 9a3b312e93df
Revises: 30318ca05bf9
Create Date: 2025-07-12 16:38:23.662545

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '9a3b312e93df'
down_revision: Union[str, None] = '30318ca05bf9'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('plan_generation_sessions',
    sa.Column('id', sa.String(length=36), nullable=False, comment='会话ID'),
    sa.Column('conversation_id', sa.String(length=36), nullable=False, comment='关联的对话会话ID'),
    sa.Column('customer_id', sa.String(length=36), nullable=False, comment='客户ID'),
    sa.Column('consultant_id', sa.String(length=36), nullable=False, comment='顾问ID'),
    sa.Column('status', sa.Enum('collecting', 'generating', 'optimizing', 'reviewing', 'completed', 'failed', 'cancelled', name='plan_session_status'), nullable=False, comment='会话状态：收集中、生成中、优化中、审核中、已完成、失败、已取消'),
    sa.Column('required_info', sa.JSON(), nullable=False, comment='必需信息清单，定义生成方案所需的信息类型'),
    sa.Column('extracted_info', sa.JSON(), nullable=True, comment='\n    从对话中提取的结构化信息 JSON格式:\n    {\n        "basic_info": {\n            "age": 25,\n            "gender": "female",\n            "skin_type": "combination",\n            "medical_history": ["acne", "sensitive_skin"]\n        },\n        "concerns": {\n            "primary_concern": "acne_scars",\n            "secondary_concerns": ["fine_lines", "dark_spots"],\n            "severity_level": "moderate",\n            "affected_areas": ["cheeks", "forehead"]\n        },\n        "budget": {\n            "budget_range": "10000-20000",\n            "payment_preference": "installment",\n            "flexibility": "moderate"\n        },\n        "timeline": {\n            "preferred_start_date": "2024-02-01",\n            "availability": "weekends",\n            "urgency_level": "normal"\n        },\n        "expectations": {\n            "desired_outcome": "clear_smooth_skin",\n            "previous_experience": "none",\n            "risk_tolerance": "low"\n        },\n        "additional_notes": "特殊要求或备注",\n        "extraction_confidence": 0.85,\n        "last_updated": "2024-01-01T10:30:00Z"\n    }\n    '),
    sa.Column('interaction_history', sa.JSON(), nullable=True, comment='\n    人机交互历史记录 JSON格式:\n    [\n        {\n            "timestamp": "2024-01-01T09:00:00Z",\n            "action": "session_started",\n            "actor": "consultant",\n            "actor_id": "consultant_id",\n            "details": {"trigger": "manual", "context": "customer_inquiry"}\n        },\n        {\n            "timestamp": "2024-01-01T09:05:00Z",\n            "action": "info_extraction_completed",\n            "actor": "ai",\n            "actor_id": "info_extraction_agent",\n            "details": {"extracted_fields": ["age", "concerns"], "confidence": 0.8}\n        },\n        {\n            "timestamp": "2024-01-01T09:10:00Z",\n            "action": "guidance_provided",\n            "actor": "ai",\n            "actor_id": "guidance_agent",\n            "details": {"missing_fields": ["budget", "timeline"], "questions": ["What\'s your budget range?"]}\n        },\n        {\n            "timestamp": "2024-01-01T09:15:00Z",\n            "action": "info_provided",\n            "actor": "consultant",\n            "actor_id": "consultant_id",\n            "details": {"method": "direct_input", "fields": ["budget"], "values": {"budget_range": "10000-20000"}}\n        }\n    ]\n    '),
    sa.Column('session_metadata', sa.JSON(), nullable=True, comment='\n    会话元数据 JSON格式:\n    {\n        "trigger_source": "chat_command",\n        "initial_message_count": 15,\n        "ai_model_version": "dify-v1.0",\n        "consultant_preferences": {\n            "auto_generation": true,\n            "review_before_send": true,\n            "preferred_style": "detailed"\n        },\n        "customer_preferences": {\n            "communication_style": "detailed",\n            "language": "zh-CN"\n        },\n        "session_config": {\n            "max_optimization_rounds": 3,\n            "require_medical_review": true,\n            "enable_customer_feedback": true\n        }\n    }\n    '),
    sa.Column('performance_metrics', sa.JSON(), nullable=True, comment='\n    性能指标 JSON格式:\n    {\n        "total_processing_time": 120,  // 秒\n        "info_extraction_time": 30,\n        "plan_generation_time": 60,\n        "optimization_rounds": 2,\n        "ai_api_calls": 5,\n        "tokens_used": 1500,\n        "success_rate": 1.0,\n        "quality_score": 0.9\n    }\n    '),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['consultant_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['conversation_id'], ['conversations.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['customer_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    comment='方案生成会话表，管理整个方案生成的生命周期'
    )
    op.create_index(op.f('ix_plan_generation_sessions_consultant_id'), 'plan_generation_sessions', ['consultant_id'], unique=False)
    op.create_index(op.f('ix_plan_generation_sessions_conversation_id'), 'plan_generation_sessions', ['conversation_id'], unique=False)
    op.create_index(op.f('ix_plan_generation_sessions_customer_id'), 'plan_generation_sessions', ['customer_id'], unique=False)
    op.create_index(op.f('ix_plan_generation_sessions_status'), 'plan_generation_sessions', ['status'], unique=False)
    op.create_table('info_completeness',
    sa.Column('id', sa.String(length=36), nullable=False, comment='记录ID'),
    sa.Column('session_id', sa.String(length=36), nullable=False, comment='关联的方案生成会话ID'),
    sa.Column('basic_info_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='基础信息状态'),
    sa.Column('basic_info_score', sa.Float(), nullable=True, comment='基础信息完整度评分 (0-1)'),
    sa.Column('concerns_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='关注点信息状态'),
    sa.Column('concerns_score', sa.Float(), nullable=True, comment='关注点完整度评分 (0-1)'),
    sa.Column('budget_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='预算信息状态'),
    sa.Column('budget_score', sa.Float(), nullable=True, comment='预算完整度评分 (0-1)'),
    sa.Column('timeline_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='时间安排状态'),
    sa.Column('timeline_score', sa.Float(), nullable=True, comment='时间安排完整度评分 (0-1)'),
    sa.Column('medical_history_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='病史信息状态'),
    sa.Column('medical_history_score', sa.Float(), nullable=True, comment='病史完整度评分 (0-1)'),
    sa.Column('expectations_status', sa.Enum('missing', 'partial', 'complete', name='info_status'), nullable=False, comment='期望信息状态'),
    sa.Column('expectations_score', sa.Float(), nullable=True, comment='期望完整度评分 (0-1)'),
    sa.Column('completeness_score', sa.Float(), nullable=True, comment='总体完整度评分 (0-1)'),
    sa.Column('missing_fields', sa.JSON(), nullable=True, comment='\n    缺失信息详情 JSON格式:\n    {\n        "basic_info": {\n            "missing": ["age", "skin_type"],\n            "partial": ["medical_history"],\n            "required": ["age", "gender", "skin_type", "medical_history"]\n        },\n        "concerns": {\n            "missing": ["severity_level"],\n            "partial": ["secondary_concerns"],\n            "required": ["primary_concern", "secondary_concerns", "severity_level"]\n        },\n        "budget": {\n            "missing": ["budget_range", "payment_preference"],\n            "partial": [],\n            "required": ["budget_range", "payment_preference"]\n        }\n    }\n    '),
    sa.Column('guidance_questions', sa.JSON(), nullable=True, comment='\n    AI生成的引导问题 JSON格式:\n    {\n        "basic_info": [\n            {\n                "field": "age",\n                "question": "请问您的年龄是多少？",\n                "priority": "high",\n                "category": "basic_info"\n            }\n        ],\n        "concerns": [\n            {\n                "field": "severity_level",\n                "question": "您觉得这个问题的严重程度如何？（轻微/中等/严重）",\n                "priority": "medium",\n                "category": "concerns"\n            }\n        ],\n        "generated_at": "2024-01-01T09:30:00Z",\n        "total_questions": 5\n    }\n    '),
    sa.Column('suggestions', sa.JSON(), nullable=True, comment='\n    改进建议 JSON格式:\n    {\n        "next_steps": [\n            "询问客户的具体年龄",\n            "了解客户的预算范围",\n            "确认客户的时间安排"\n        ],\n        "conversation_tips": [\n            "可以先从客户最关心的问题开始询问",\n            "预算问题可以放在最后讨论"\n        ],\n        "auto_suggestions": [\n            "基于客户的其他信息，推测年龄可能在25-35岁之间",\n            "根据选择的治疗项目，预算可能在10000-20000元"\n        ]\n    }\n    '),
    sa.Column('last_analysis_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='最后分析时间'),
    sa.Column('analysis_version', sa.Integer(), nullable=True, comment='分析版本号'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['session_id'], ['plan_generation_sessions.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('session_id'),
    comment='信息完整性表，跟踪客户信息的完整性状态'
    )
    op.create_table('plan_drafts',
    sa.Column('id', sa.String(length=36), nullable=False, comment='草稿ID'),
    sa.Column('session_id', sa.String(length=36), nullable=False, comment='关联的方案生成会话ID'),
    sa.Column('version', sa.Integer(), nullable=False, comment='版本号'),
    sa.Column('parent_version', sa.Integer(), nullable=True, comment='父版本号（用于版本分支）'),
    sa.Column('status', sa.Enum('draft', 'reviewing', 'approved', 'rejected', 'archived', name='plan_draft_status'), nullable=False, comment='草稿状态：草稿、审核中、已确认、已拒绝、已归档'),
    sa.Column('content', sa.JSON(), nullable=False, comment='\n    结构化的方案内容 JSON格式:\n    {\n        "basic_info": {\n            "title": "个性化美肌方案",\n            "description": "针对痤疮疤痕和细纹的综合治疗方案",\n            "target_concerns": ["acne_scars", "fine_lines"],\n            "difficulty_level": "intermediate",\n            "total_duration": "3-6个月"\n        },\n        "analysis": {\n            "skin_analysis": "皮肤状态分析",\n            "concern_priority": ["acne_scars", "fine_lines", "dark_spots"],\n            "treatment_approach": "分阶段治疗",\n            "expected_timeline": "6个月"\n        },\n        "treatment_plan": {\n            "phases": [\n                {\n                    "phase": 1,\n                    "name": "基础治疗期",\n                    "duration": "1-2个月",\n                    "treatments": [\n                        {\n                            "name": "微针治疗",\n                            "frequency": "每月1次",\n                            "sessions": 2,\n                            "price_per_session": 1200,\n                            "total_price": 2400\n                        }\n                    ]\n                }\n            ]\n        },\n        "cost_breakdown": {\n            "treatment_costs": 15000,\n            "product_costs": 2000,\n            "maintenance_costs": 1000,\n            "total_cost": 18000,\n            "payment_options": ["full_payment", "installment_3", "installment_6"]\n        },\n        "timeline": {\n            "start_date": "2024-02-01",\n            "key_milestones": [\n                {"date": "2024-02-15", "milestone": "第一次治疗"},\n                {"date": "2024-03-15", "milestone": "第二次治疗"},\n                {"date": "2024-04-01", "milestone": "第一阶段评估"}\n            ],\n            "completion_date": "2024-08-01"\n        },\n        "risks_and_precautions": {\n            "potential_risks": ["轻微红肿", "暂时性色素沉着"],\n            "contraindications": ["怀孕", "哺乳期"],\n            "precautions": ["避免阳光直射", "使用防晒霜"],\n            "emergency_contact": "clinic_phone"\n        },\n        "aftercare": {\n            "immediate_care": ["冰敷", "保湿"],\n            "long_term_care": ["定期复查", "护肤维护"],\n            "product_recommendations": ["温和洁面乳", "修复精华"]\n        }\n    }\n    '),
    sa.Column('feedback', sa.JSON(), nullable=True, comment='\n    反馈意见 JSON格式:\n    {\n        "consultant_feedback": {\n            "rating": 4,\n            "comments": "整体方案合理，建议调整治疗频率",\n            "suggestions": ["降低治疗频率", "增加护理产品"],\n            "timestamp": "2024-01-01T10:30:00Z",\n            "consultant_id": "consultant_id"\n        },\n        "customer_feedback": {\n            "rating": 5,\n            "comments": "方案很详细，价格可以接受",\n            "concerns": ["治疗时间较长"],\n            "preferences": ["周末治疗"],\n            "timestamp": "2024-01-01T11:00:00Z",\n            "customer_id": "customer_id"\n        },\n        "medical_review": {\n            "approved": true,\n            "reviewer": "doctor_id",\n            "comments": "医学上可行，注意风险提示",\n            "modifications": ["增加过敏测试"],\n            "timestamp": "2024-01-01T14:00:00Z"\n        }\n    }\n    '),
    sa.Column('improvements', sa.JSON(), nullable=True, comment='\n    改进记录 JSON格式:\n    {\n        "version_changes": [\n            {\n                "change_type": "content_modification",\n                "section": "treatment_plan",\n                "description": "调整治疗频率从每月2次改为每月1次",\n                "reason": "根据顾问建议",\n                "timestamp": "2024-01-01T10:45:00Z"\n            },\n            {\n                "change_type": "cost_adjustment",\n                "section": "cost_breakdown",\n                "description": "增加分期付款选项",\n                "reason": "客户要求",\n                "timestamp": "2024-01-01T11:15:00Z"\n            }\n        ],\n        "ai_optimization": {\n            "optimization_rounds": 2,\n            "improvements_made": ["成本优化", "时间调整"],\n            "quality_score": 0.9,\n            "confidence_level": 0.85\n        }\n    }\n    '),
    sa.Column('generation_info', sa.JSON(), nullable=True, comment='\n    生成信息 JSON格式:\n    {\n        "generator": "ai",\n        "ai_model": "dify-plan-generator-v1.0",\n        "generation_method": "template_based",\n        "template_used": "comprehensive_beauty_plan",\n        "generation_time": 45,  // 秒\n        "tokens_used": 800,\n        "confidence_score": 0.88,\n        "quality_metrics": {\n            "completeness": 0.95,\n            "consistency": 0.92,\n            "feasibility": 0.85\n        }\n    }\n    '),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['session_id'], ['plan_generation_sessions.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    comment='方案草稿表，存储方案的不同版本'
    )
    op.create_index(op.f('ix_plan_drafts_session_id'), 'plan_drafts', ['session_id'], unique=False)
    op.create_index(op.f('ix_plan_drafts_status'), 'plan_drafts', ['status'], unique=False)
    op.alter_column('ai_model_configs', 'api_key',
               existing_type=sa.TEXT(),
               comment='API密钥（加密存储）',
               existing_comment='API密钥（非Dify时必填，加密存储）',
               existing_nullable=True)
    op.alter_column('ai_model_configs', 'base_url',
               existing_type=sa.VARCHAR(length=1024),
               comment='API基础URL',
               existing_comment='API基础URL（非Dify时必填）',
               existing_nullable=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('ai_model_configs', 'base_url',
               existing_type=sa.VARCHAR(length=1024),
               comment='API基础URL（非Dify时必填）',
               existing_comment='API基础URL',
               existing_nullable=True)
    op.alter_column('ai_model_configs', 'api_key',
               existing_type=sa.TEXT(),
               comment='API密钥（非Dify时必填，加密存储）',
               existing_comment='API密钥（加密存储）',
               existing_nullable=True)
    op.drop_index(op.f('ix_plan_drafts_status'), table_name='plan_drafts')
    op.drop_index(op.f('ix_plan_drafts_session_id'), table_name='plan_drafts')
    op.drop_table('plan_drafts')
    op.drop_table('info_completeness')
    op.drop_index(op.f('ix_plan_generation_sessions_status'), table_name='plan_generation_sessions')
    op.drop_index(op.f('ix_plan_generation_sessions_customer_id'), table_name='plan_generation_sessions')
    op.drop_index(op.f('ix_plan_generation_sessions_conversation_id'), table_name='plan_generation_sessions')
    op.drop_index(op.f('ix_plan_generation_sessions_consultant_id'), table_name='plan_generation_sessions')
    op.drop_table('plan_generation_sessions')
    # ### end Alembic commands ###
