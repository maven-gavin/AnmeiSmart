# 架构映射战略设计方案  
（基于领域驱动设计统一过程）  
版本：V1.0

---

### 1 系统上下文

#### 1.1 概述

本系统为医美机构提供一体化智能服务平台，服务对象包括客户、医美顾问、医生、运营人员、管理员。系统边界涵盖前端Web应用、后端API服务、AI服务、数据库、外部系统（如CRM、第三方AI平台等）。  
（建议补充系统上下文图，示意用户、系统、外部服务的关系）

#### 1.2 系统协作

**主要业务流程与协作关系：**

- 客户通过Web端注册/登录，发起咨询、预约、查看记录等操作，系统与后端API、AI服务、数据库交互。
- 顾问/医生通过Web端为客户制定方案，系统自动调用用药冲突检测、风险评估等AI服务。
- 运营人员通过数据大屏、方案审核等功能与系统交互，系统聚合分析数据、管理方案流转。
- 管理员通过后台管理用户、角色、权限，系统负责权限校验与配置。
- 外部系统如CRM可通过API集成，实现数据同步与业务协同。

---

### 2 业务架构

#### 2.1 业务组件

根据全局分析与业务服务，识别以下限界上下文（业务组件）：

- 智能沟通（ChatContext）：负责多模态咨询、AI/人工回复、消息检索
- 方案与安全（PlanSafetyContext）：负责治疗方案录入、用药冲突检测、风险评估
- 运营分析（OpsContext）：负责数据大屏、方案审核、统计分析
- 用户与权限（UserAuthContext）：负责用户注册、登录、角色分配、权限管理

**业务服务图：**  
- 客户端、顾问端、医生端、运营端、管理员端前端页面分别调用上述业务组件的服务。
- 业务组件与AI服务、数据库、外部系统（如CRM）存在接口调用关系。

**服务列表举例：**

| 业务组件           | 业务服务功能           | 前端调用 | 伴生系统调用 |
|-------------------|-----------------------|----------|--------------|
| ChatContext       | 智能咨询、消息检索     | 是       | AI服务       |
| PlanSafetyContext | 方案录入、用药检测     | 是       | AI服务       |
| OpsContext        | 数据分析、方案审核     | 是       | -            |
| UserAuthContext   | 用户/角色管理、登录    | 是       | -            |

#### 2.2 业务架构视图

- 核心子领域：智能沟通、方案与安全
- 支撑子领域：运营分析
- 通用子领域：用户与权限

业务架构视图为多限界上下文协作，前端页面与各业务组件解耦，组件间通过API/服务契约集成。

---

### 3 应用架构

#### 3.1 应用组件

- ChatService（聊天服务，限界上下文：ChatContext）
- PlanService（方案与安全服务，限界上下文：PlanSafetyContext）
- OpsService（运营分析服务，限界上下文：OpsContext）
- UserService（用户与权限服务，限界上下文：UserAuthContext）
- AIAdapter（AI服务适配器，供ChatService/PlanService调用）
- DataStore（数据库服务，所有服务共享）

各应用组件以服务/库形式实现，内部遵循分层架构（如Controller-Service-Repository），对外暴露RESTful API。

#### 3.2 应用架构视图

- 表现层：Next.js前端（各端页面、组件）
- 业务层：各限界上下文服务（ChatService、PlanService等）
- AI集成层：AIAdapter
- 数据层：DataStore（PostgreSQL、MongoDB等）

---

### 4 子领域架构

#### 4.1 核心子领域

**智能沟通（ChatContext）**

- 业务能力：多模态消息收发、AI/人工回复、消息检索
- 应用组件：ChatService
- 上下文映射图：前端页面 <-> ChatService <-> AIAdapter <-> AI服务
- 服务契约列表（表D-1）：

| 服务功能   | 服务功能描述           | 服务方法   | 生产者     | 消费者     | 模式   | 业务服务   | 服务操作类型 |
|------------|----------------------|------------|------------|------------|--------|------------|--------------|
| sendMsg    | 发送消息              | POST /msg  | ChatService| 前端       | 同步   | 智能咨询   | 命令        |
| getHistory | 获取历史消息          | GET /msg   | ChatService| 前端       | 同步   | 消息检索   | 查询        |
| aiReply    | AI自动回复            | POST /ai   | AIAdapter  | ChatService| 异步   | 智能咨询   | 事件        |

**方案与安全（PlanSafetyContext）**

- 业务能力：方案录入、用药冲突检测、风险评估
- 应用组件：PlanService
- 上下文映射图：前端页面 <-> PlanService <-> AIAdapter <-> AI服务
- 服务契约列表（表D-1）：

| 服务功能   | 服务功能描述           | 服务方法         | 生产者     | 消费者     | 模式   | 业务服务   | 服务操作类型 |
|------------|----------------------|------------------|------------|------------|--------|------------|--------------|
| createPlan | 创建治疗方案          | POST /plan       | PlanService| 前端       | 同步   | 方案录入   | 命令        |
| checkDrug  | 用药冲突检测          | POST /plan/check | AIAdapter  | PlanService| 同步   | 用药检测   | 查询        |
| riskEval   | 风险评估              | POST /plan/risk  | AIAdapter  | PlanService| 同步   | 风险评估   | 查询        |

#### 4.2 支撑子领域

**运营分析（OpsContext）**

- 业务能力：数据统计、方案审核
- 应用组件：OpsService
- 服务契约列表（表D-1）：

| 服务功能   | 服务功能描述           | 服务方法         | 生产者     | 消费者     | 模式   | 业务服务   | 服务操作类型 |
|------------|----------------------|------------------|------------|------------|--------|------------|--------------|
| getStats   | 获取运营统计数据      | GET /ops/stats   | OpsService | 前端       | 同步   | 数据分析   | 查询        |
| auditPlan  | 审核治疗方案          | POST /ops/audit  | OpsService | 前端       | 同步   | 方案审核   | 命令        |

#### 4.3 通用子领域

**用户与权限（UserAuthContext）**

- 业务能力：用户注册、登录、角色分配、权限管理
- 应用组件：UserService
- 服务契约列表（表D-1）：

| 服务功能   | 服务功能描述           | 服务方法         | 生产者     | 消费者     | 模式   | 业务服务   | 服务操作类型 |
|------------|----------------------|------------------|------------|------------|--------|------------|--------------|
| register   | 用户注册              | POST /user/reg   | UserService| 前端       | 同步   | 用户管理   | 命令        |
| login      | 用户登录              | POST /user/login | UserService| 前端       | 同步   | 用户管理   | 命令        |
| assignRole | 分配角色              | POST /user/role  | UserService| 前端       | 同步   | 角色管理   | 命令        |
| checkPerm  | 权限校验              | GET /user/perm   | UserService| 各服务     | 同步   | 权限管理   | 查询        |
