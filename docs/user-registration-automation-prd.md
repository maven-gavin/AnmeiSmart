# ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–æµç¨‹ PRDæ–‡æ¡£

## 1. äº§å“æ¦‚è¿°

### 1.1 èƒŒæ™¯æè¿°

å®‰ç¾æ™ºäº«åŒ»ç¾å’¨è¯¢ç³»ç»Ÿéœ€è¦å®ç°ç”¨æˆ·æ³¨å†Œåçš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œä¸ºæ–°ç”¨æˆ·æä¾›æ— ç¼çš„åˆå§‹ä½“éªŒã€‚å½“ç”¨æˆ·å®Œæˆæ³¨å†Œåï¼Œç³»ç»Ÿåº”è‡ªåŠ¨åˆ›å»ºä¼šè¯ã€å‘é€ä¸ªæ€§åŒ–æ¬¢è¿æ¶ˆæ¯ï¼Œå¹¶é€šçŸ¥é¡¾é—®å›¢é˜Ÿæœ‰æ–°å®¢æˆ·éœ€è¦æœåŠ¡ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **ç”¨æˆ·ä½“éªŒæå‡**ï¼šæ–°ç”¨æˆ·æ³¨å†Œåç«‹å³è·å¾—ä¸“ä¸šAIå“åº”å’ŒæœåŠ¡
- **ä¸šåŠ¡è½¬åŒ–ä¼˜åŒ–**ï¼šç¡®ä¿æ–°å®¢æˆ·èƒ½å¿«é€Ÿæ¥å…¥å’¨è¯¢æœåŠ¡
- **è¿è¥æ•ˆç‡æå‡**ï¼šè‡ªåŠ¨åŒ–æµç¨‹å‡å°‘äººå·¥ä»‹å…¥ï¼Œæé«˜æœåŠ¡å“åº”é€Ÿåº¦

## 2. éœ€æ±‚åˆ†æ

### 2.1 ä¸šåŠ¡éœ€æ±‚

| éœ€æ±‚ID | éœ€æ±‚æè¿°                            | ä¼˜å…ˆçº§ | éªŒæ”¶æ ‡å‡†                                                              |
| ------ | ----------------------------------- | ------ | --------------------------------------------------------------------- |
| R001   | ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨åˆ›å»ºé»˜è®¤ä¼šè¯      | P0     | æ–°ç”¨æˆ·åœ¨æ³¨å†ŒæˆåŠŸå2ç§’å†…è‡ªåŠ¨åˆ›å»ºä¼šè¯ï¼ŒæŒ‡å®šé€šç”¨AIæœºå™¨äºº                 |
| R002   | Dify Agenté€šè¿‡MCPç”Ÿæˆä¸ªæ€§åŒ–æ¬¢è¿æ¶ˆæ¯ | P0     | Dify Agenté€šè¿‡MCPè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç”Ÿæˆå®šåˆ¶åŒ–æ¬¢è¿è¯­ï¼ŒAI Gatewayè½¬å‘ç»™å®¢æˆ· |
| R003   | é¡¾é—®ç«¯æ¥æ”¶æ–°å®¢æˆ·é€šçŸ¥                | P1     | ç³»ç»Ÿå‘åœ¨çº¿é¡¾é—®æ¨é€æ–°å®¢æˆ·æ¶ˆæ¯ï¼Œç¦»çº¿é¡¾é—®æ¥æ”¶æ¨é€é€šçŸ¥                    |

### 2.2 æ€§èƒ½éœ€æ±‚

| æŒ‡æ ‡     | ç›®æ ‡å€¼        | è¯´æ˜                             |
| -------- | ------------- | -------------------------------- |
| å“åº”æ—¶é—´ | â‰¤ 3ç§’        | ç”¨æˆ·æ³¨å†Œåˆ°æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯çš„æ€»æ—¶é—´   |
| å¼‚æ­¥å¤„ç† | 100%          | æ‰€æœ‰æµç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡æ³¨å†Œå“åº” |
| æˆåŠŸç‡   | â‰¥ 99%        | åŒ…å«é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æœ€ç»ˆæˆåŠŸ       |
| å¹¶å‘æ”¯æŒ | 100 ç”¨æˆ·/åˆ†é’Ÿ | æ”¯æŒé«˜å¹¶å‘æ³¨å†Œåœºæ™¯               |

### 2.3 æŠ€æœ¯éœ€æ±‚

- **å¼‚æ­¥æ¶æ„**ï¼šåŸºäºFastAPIåå°ä»»åŠ¡å’Œäº‹ä»¶é©±åŠ¨æ¶æ„
- **å¯é æ€§ä¿è¯**ï¼šå…·å¤‡é‡è¯•æœºåˆ¶å’Œé”™è¯¯æ¢å¤èƒ½åŠ›
- **ç›‘æ§ä¸æ—¥å¿—**ï¼šå®Œæ•´çš„æ‰§è¡Œæ—¥å¿—å’Œæ€§èƒ½ç›‘æ§
- **æ‰©å±•æ€§è®¾è®¡**ï¼šæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

## 3. ç³»ç»Ÿè®¾è®¡

### 3.1 æŠ€æœ¯æ¶æ„

åŸºäºç°æœ‰çš„AI Gatewayä¼ä¸šçº§æ¶æ„ï¼Œç»“åˆMCPæœåŠ¡ä½“ç³»çš„å®Œæ•´è®¾è®¡ï¼š

```mermaid
graph TB
    subgraph "AnmeiSmart ç³»ç»Ÿæ¶æ„"
        A[ç”¨æˆ·æ³¨å†ŒAPI] --> B[æ³¨å†Œè‡ªåŠ¨åŒ–æœåŠ¡]
        B --> C[AI Gateway Service]
        B --> D[MCP Server Service]
      
        subgraph "APIæœåŠ¡å±‚ (/api/v1)"
            C --> E[ai_gateway.py - AI Gatewayç®¡ç†]
            C --> F[ai.py - AIæœåŠ¡æ¥å£]
            C --> G[chat.py - èŠå¤©æ¥å£]
            C --> H[plan_generation.py - æ–¹æ¡ˆç”Ÿæˆ]
            C --> I[dify_config.py - Difyé…ç½®]
        end
      
        subgraph "MCPæœåŠ¡å±‚ (/mcp/v1)"
            D --> J[ç”¨æˆ·ä¿¡æ¯æœåŠ¡]
            D --> K[å®¢æˆ·ç”»åƒæœåŠ¡]
            D --> L[ä¼šè¯åˆ†ææœåŠ¡]
            D --> M[ä¸šåŠ¡æ•°æ®æœåŠ¡]
        end
      
        I --> N[Dify Agenté…ç½®æŸ¥è¯¢]
        N --> O[é€šè¿‡AI Gatewayè§¦å‘Dify Agent]
    end
  
    subgraph "Dify ç³»ç»Ÿ"
        O --> P[æ¬¢è¿æ¶ˆæ¯Agent]
        P --> Q[MCPå·¥å…·è°ƒç”¨]
        Q --> J
        P --> R[ç”Ÿæˆä¸ªæ€§åŒ–æ¬¢è¿è¯­]
    end
  
    R --> S[è¿”å›æ¬¢è¿æ¶ˆæ¯]
    S --> T[ä¿å­˜å¹¶å¹¿æ’­æ¶ˆæ¯]
  
    style B fill:#e1f5fe
    style D fill:#f3e5f5
    style P fill:#fff3e0
    style T fill:#e8f5e8
```

**ğŸ“‹ æ¶æ„è¯´æ˜**ï¼š
âœ… **ä¸ç°æœ‰ä»£ç ä¸€è‡´**ï¼šç»è¿‡ä»£ç åˆ†æï¼Œå½“å‰ç³»ç»Ÿç¡®å®æœ‰ç‹¬ç«‹çš„APIç«¯ç‚¹

- `ai_gateway.py`ï¼šAI Gatewayç®¡ç†APIï¼ŒåŒ…å«èŠå¤©ã€æ–¹æ¡ˆç”Ÿæˆã€å¥åº·æ£€æŸ¥ç­‰åŠŸèƒ½
- `ai.py`ï¼šé¢å‘ç”¨æˆ·çš„AIåŠŸèƒ½æ¥å£
- `chat.py`ï¼šèŠå¤©ç›¸å…³API
- `plan_generation.py`ï¼šAIè¾…åŠ©æ–¹æ¡ˆç”Ÿæˆä¸“ç”¨API
- `dify_config.py`ï¼šDifyé…ç½®ç®¡ç†APIï¼ˆå·²æ”¯æŒåŠ¨æ€é…ç½®å’Œçƒ­é‡è½½ï¼‰

### 3.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 3.2.1 æ³¨å†Œè‡ªåŠ¨åŒ–æœåŠ¡ (RegistrationAutomationService)

```python
class RegistrationAutomationService:
    """ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–æœåŠ¡"""
  
    async def handle_user_registration(self, user_id: str, user_info: dict):
        """å¤„ç†ç”¨æˆ·æ³¨å†Œåçš„è‡ªåŠ¨åŒ–æµç¨‹"""
        pass
  
    async def create_default_conversation(self, user_id: str) -> ConversationInfo:
        """åˆ›å»ºé»˜è®¤ä¼šè¯"""
        pass
  
    async def trigger_dify_welcome(self, user_id: str, conversation_id: str):
        """è§¦å‘Dify Agentç”Ÿæˆä¸ªæ€§åŒ–æ¬¢è¿æ¶ˆæ¯"""
        pass
  
    async def notify_consultants(self, user_id: str, conversation_id: str):
        """é€šçŸ¥é¡¾é—®æœ‰æ–°å®¢æˆ·"""
        pass
```

#### 3.2.2 MCPæœåŠ¡ä½“ç³»è®¾è®¡

- **MCP Serveræ¶æ„**ï¼šä¸APIåŒçº§çš„ç‹¬ç«‹æœåŠ¡å±‚ï¼Œä¸“é—¨å¯¹å¤–æä¾›MCPåè®®æœåŠ¡
- **æœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼šç»Ÿä¸€çš„MCPæœåŠ¡æ³¨å†Œã€ç‰ˆæœ¬ç®¡ç†ã€å¯ç”¨/ç¦ç”¨æœºåˆ¶
- **å·¥å…·é›†åˆç®¡ç†**ï¼šæ¨¡å—åŒ–çš„MCPå·¥å…·é›†ï¼Œæ”¯æŒæŒ‰åŠŸèƒ½åˆ†ç»„å’Œæƒé™æ§åˆ¶
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒMCPæœåŠ¡çš„åŠ¨æ€é…ç½®ã€çƒ­æ›´æ–°å’Œç°åº¦å‘å¸ƒ
- **ç›‘æ§ä¸æ—¥å¿—**ï¼šå®Œæ•´çš„MCPè°ƒç”¨ç›‘æ§ã€æ€§èƒ½ç»Ÿè®¡å’Œé”™è¯¯è¿½è¸ª

#### 3.2.3 Dify Agenté…ç½®ç®¡ç†

- **Agenté…ç½®å­˜å‚¨**ï¼šç³»ç»Ÿå†…ç»´æŠ¤Dify Agentçš„appIdå’ŒdifyKeyæ˜ å°„å…³ç³»
- **è§¦å‘æœºåˆ¶**ï¼šé€šè¿‡AI GatewayæŸ¥è¯¢é…ç½®ï¼Œä½¿ç”¨å¯¹åº”çš„difyKeyè°ƒç”¨æŒ‡å®šAgent
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒAgentçš„ç‰ˆæœ¬æ§åˆ¶å’ŒA/Bæµ‹è¯•
- **æ•…éšœè½¬ç§»**ï¼šAgentä¸å¯ç”¨æ—¶çš„è‡ªåŠ¨é™çº§å’Œå›é€€æœºåˆ¶

#### 3.2.4 é¡¾é—®é€šçŸ¥ç³»ç»Ÿ

- **åœ¨çº¿é€šçŸ¥**ï¼šé€šè¿‡WebSocketå®æ—¶æ¨é€
- **ç¦»çº¿é€šçŸ¥**ï¼šé€šè¿‡NotificationServiceå‘é€æ¨é€
- **é€šçŸ¥å†…å®¹**ï¼šæ–°å®¢æˆ·åŸºæœ¬ä¿¡æ¯ã€ä¼šè¯é“¾æ¥ã€é¢„æœŸå“åº”æ—¶é—´

### 3.3 æ•°æ®æµè®¾è®¡

#### 3.3.1 æ³¨å†Œæµç¨‹æ•°æ®æµ

```
ç”¨æˆ·æ³¨å†Œ â†’ ç”¨æˆ·ä¿¡æ¯éªŒè¯ â†’ åˆ›å»ºç”¨æˆ·è®°å½• â†’ è§¦å‘å¼‚æ­¥ä»»åŠ¡
                                        â†“
                            åˆ›å»ºä¼šè¯ â†’ æŸ¥è¯¢Dify Agenté…ç½®ï¼ˆappIdâ†’difyKeyï¼‰
                                        â†“
                            AI Gatewayè°ƒç”¨Dify Agent â†’ Dify Agentè°ƒç”¨MCPè·å–ç”¨æˆ·ä¿¡æ¯
                                        â†“
                            æ¬¢è¿æ¶ˆæ¯ç”Ÿæˆ â† Dify Agentè¿”å›æ¬¢è¿è¯­ â† MCPè¿”å›ç”¨æˆ·ç”»åƒ
                                        â†“
                            ä¿å­˜æ¶ˆæ¯ â†’ å¹¿æ’­é¡¾é—®é€šçŸ¥ â†’ æ›´æ–°ç®¡ç†å‘˜é¢æ¿æŒ‡æ ‡
```

#### 3.3.2 é‡è¯•æœºåˆ¶æ•°æ®æµ

```
ä»»åŠ¡æ‰§è¡Œå¤±è´¥ â†’ è®°å½•é”™è¯¯æ—¥å¿— â†’ è®¡ç®—é‡è¯•å»¶è¿Ÿ â†’ é‡æ–°å…¥é˜Ÿ â†’ é‡æ–°æ‰§è¡Œ
                    â†“ï¼ˆè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰
              å‘é€ç®¡ç†å‘˜å‘Šè­¦ â†’ æ‰‹åŠ¨å¤„ç†
```

## 4. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 4.1 ä»£ç æ¶æ„

#### 4.1.1 ç›®å½•ç»“æ„

```
api/app/
â”œâ”€â”€ api/v1/                        # ç°æœ‰APIæœåŠ¡å±‚
â”‚   â”œâ”€â”€ endpoints/
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â”œâ”€â”€ plan_generation.py
â”‚   â”‚   â”œâ”€â”€ dify_config.py        # ç°æœ‰Difyé…ç½®ç®¡ç†ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ mcp_config.py         # æ–°å¢MCPé…ç½®ç®¡ç†API
â”‚   â””â”€â”€ api.py
â”œâ”€â”€ mcp/v1/                        # æ–°å¢MCPæœåŠ¡å±‚ï¼ˆä¸APIåŒçº§ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ server.py                  # MCPæœåŠ¡å™¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ registry.py               # MCPæœåŠ¡æ³¨å†Œä¸­å¿ƒ
â”‚   â”œâ”€â”€ tools/                    # MCPå·¥å…·é›†åˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_profile.py       # ç”¨æˆ·ä¿¡æ¯å·¥å…·
â”‚   â”‚   â”œâ”€â”€ customer_analysis.py  # å®¢æˆ·åˆ†æå·¥å…·
â”‚   â”‚   â”œâ”€â”€ conversation_data.py  # ä¼šè¯æ•°æ®å·¥å…·
â”‚   â”‚   â””â”€â”€ business_metrics.py   # ä¸šåŠ¡æŒ‡æ ‡å·¥å…·
â”‚   â”œâ”€â”€ middleware/               # MCPä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ mcp_auth.py          # MCPè°ƒç”¨è®¤è¯ä¸­é—´ä»¶ï¼ˆéªŒè¯Difyæä¾›çš„appKeyï¼‰
â”‚   â”‚   â”œâ”€â”€ logging.py           # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ monitoring.py        # ç›‘æ§ä¸­é—´ä»¶
â”‚   â””â”€â”€ config/                  # MCPé…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ tool_config.py       # å·¥å…·é…ç½®
â”‚       â””â”€â”€ version_manager.py   # ç‰ˆæœ¬ç®¡ç†
â””â”€â”€ services/
    â”œâ”€â”€ mcp_group_service.py         # MCPå·¥å…·åˆ†ç»„æœåŠ¡ï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ registration/
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ automation_service.py    # æ ¸å¿ƒè‡ªåŠ¨åŒ–æœåŠ¡ï¼ˆå¤ç”¨ç°æœ‰dify_serviceï¼‰
        â””â”€â”€ consultant_notifier.py   # é¡¾é—®é€šçŸ¥æœåŠ¡
```

#### 4.1.2 æœåŠ¡é›†æˆç‚¹

```python
# åœ¨ auth.py æ³¨å†Œç«¯ç‚¹ä¸­é›†æˆ
@router.post("/register", response_model=UserResponse)
async def register(
    *,
    background_tasks: BackgroundTasks,  # æ–°å¢
    db: Session = Depends(get_db),
    user_in: UserCreate = Body(...),
) -> Any:
    # ç°æœ‰æ³¨å†Œé€»è¾‘...
    userResponse = await user_service.create(db, obj_in=user_in)
  
    # æ–°å¢ï¼šè§¦å‘è‡ªåŠ¨åŒ–æµç¨‹
    background_tasks.add_task(
        handle_registration_automation,
        user_id=str(userResponse.id),
        user_info=userResponse.dict()
    )
  
    return userResponse
```

### 4.2 å¼‚æ­¥ä»»åŠ¡è®¾è®¡

#### 4.2.1 ä¸»ä»»åŠ¡å‡½æ•°

```python
async def handle_registration_automation(user_id: str, user_info: dict):
    """æ³¨å†Œè‡ªåŠ¨åŒ–ä¸»ä»»åŠ¡"""
    try:
        automation_service = RegistrationAutomationService()
        await automation_service.handle_user_registration(user_id, user_info)
    except Exception as e:
        logger.error(f"æ³¨å†Œè‡ªåŠ¨åŒ–å¤±è´¥: user_id={user_id}, error={e}")
        # è§¦å‘é‡è¯•æœºåˆ¶
        await schedule_retry_task(user_id, user_info, attempt=1)
```

#### 4.2.2 é‡è¯•æœºåˆ¶

```python
async def schedule_retry_task(user_id: str, user_info: dict, attempt: int):
    """å®‰æ’é‡è¯•ä»»åŠ¡"""
    max_retries = 3
    retry_delays = [5, 15, 60]  # ç§’
  
    if attempt <= max_retries:
        delay = retry_delays[attempt - 1]
        # ä½¿ç”¨Redisæˆ–Celeryå®ç°å»¶è¿Ÿä»»åŠ¡
        await asyncio.sleep(delay)
        await handle_registration_automation(user_id, user_info)
    else:
        # å‘é€ç®¡ç†å‘˜å‘Šè­¦
        await send_admin_alert(f"ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–æœ€ç»ˆå¤±è´¥: {user_id}")
```

### 4.3 MCPæœåŠ¡ä½“ç³»ä¸AI Gatewayé›†æˆæ–¹æ¡ˆ

#### 4.3.1 MCPæœåŠ¡æ³¨å†Œä¸ç®¡ç†

```python
# app/mcp/v1/registry.py
class MCPServiceRegistry:
    """MCPæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰MCPå·¥å…·çš„ç”Ÿå‘½å‘¨æœŸ"""
  
    def __init__(self):
        self.tools = {}
        self.versions = {}
        self.status = {}  # enabled/disabled
      
    def register_tool(self, name: str, tool_class, version: str = "1.0.0"):
        """æ³¨å†ŒMCPå·¥å…·"""
        self.tools[name] = tool_class
        self.versions[name] = version
        self.status[name] = "enabled"
      
    def get_available_tools(self) -> dict:
        """è·å–å¯ç”¨çš„MCPå·¥å…·åˆ—è¡¨"""
        return {
            name: {
                "class": tool_class,
                "version": self.versions[name],
                "status": self.status[name]
            }
            for name, tool_class in self.tools.items()
            if self.status[name] == "enabled"
        }
  
    def enable_tool(self, name: str):
        """å¯ç”¨MCPå·¥å…·"""
        self.status[name] = "enabled"
      
    def disable_tool(self, name: str):
        """ç¦ç”¨MCPå·¥å…·"""
        self.status[name] = "disabled"

# app/mcp/v1/tools/user_profile.py
class UserProfileTool:
    """ç”¨æˆ·ä¿¡æ¯MCPå·¥å…·"""
  
    name = "get_user_profile"
    version = "1.0.0"
    description = "è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹"
  
    async def execute(self, user_id: str) -> dict:
        """æ‰§è¡Œç”¨æˆ·ä¿¡æ¯è·å–"""
        try:
            user = await user_service.get(self.db, id=user_id)
            return {
                "user_id": user.id,
                "username": user.username,
                "email": user.email,
                "registration_time": user.created_at.isoformat(),
                "roles": user.roles,
                "is_new_user": True,
                "source": "registration_automation"
            }
        except Exception as e:
            logger.error(f"MCPè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: {e}")
            return {"error": str(e)}
```

#### 4.3.2 å¤ç”¨ç°æœ‰DifyæœåŠ¡æ¶æ„

åŸºäºé¡¹ç›®ä»£ç æ•´æ´å’Œæ˜“ç»´æŠ¤åŸåˆ™ï¼Œå¤ç”¨ç°æœ‰çš„DifyæœåŠ¡è€Œéåˆ›å»ºæ–°çš„ç®¡ç†å™¨ï¼š

```python
# app/services/registration/automation_service.py
class RegistrationAutomationService:
    """æ³¨å†Œè‡ªåŠ¨åŒ–æœåŠ¡ï¼Œå¤ç”¨ç°æœ‰Difyæ¶æ„"""
  
    def __init__(self, db: Session):
        self.db = db
        # å¤ç”¨ç°æœ‰çš„AI GatewayæœåŠ¡
        self.ai_gateway = get_ai_gateway_service(db)
      
    async def trigger_welcome_message(self, user_id: str, conversation_id: str):
        """è§¦å‘æ¬¢è¿æ¶ˆæ¯ç”Ÿæˆï¼ˆå¤ç”¨ç°æœ‰AI Gatewayï¼‰"""
        try:
            # ç›´æ¥ä½¿ç”¨AI Gatewayçš„customer_service_chatåŠŸèƒ½
            # AI Gatewayå†…éƒ¨ä¼šæ ¹æ®dify_config.pyçš„é…ç½®é€‰æ‹©åˆé€‚çš„Agent
            response = await self.ai_gateway.customer_service_chat(
                message=f"æ–°ç”¨æˆ· {user_id} åˆšåˆšæ³¨å†Œï¼Œè¯·ç”Ÿæˆä¸ªæ€§åŒ–æ¬¢è¿æ¶ˆæ¯",
                user_id=user_id,
                session_id=conversation_id,
                conversation_history=[],
                user_profile={"is_new_user": True, "source": "registration"}
            )
          
            if response.success:
                return response.content
            else:
                logger.warning(f"AI Gatewayè°ƒç”¨å¤±è´¥: {response.error_message}")
                return self._get_default_welcome_message(user_id)
              
        except Exception as e:
            logger.error(f"è§¦å‘æ¬¢è¿æ¶ˆæ¯å¤±è´¥: {e}")
            return self._get_default_welcome_message(user_id)
  
    def _get_default_welcome_message(self, user_id: str) -> str:
        """é»˜è®¤æ¬¢è¿æ¶ˆæ¯æ¨¡æ¿"""
        return """
        æ¬¢è¿æ¥åˆ°å®‰ç¾æ™ºäº«ï¼ğŸŒŸ
      
        æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIå’¨è¯¢åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚
        æ‚¨å¯ä»¥éšæ—¶å‘æˆ‘å’¨è¯¢åŒ»ç¾ç›¸å…³é—®é¢˜ï¼Œè·å¾—ä¸ªæ€§åŒ–çš„ç¾å®¹å»ºè®®ã€‚
        """

# è¯´æ˜ï¼š
# 1. å¤ç”¨ç°æœ‰çš„AI Gateway Serviceï¼ˆå·²åœ¨ai_gateway.pyä¸­å®ç°ï¼‰
# 2. å¤ç”¨ç°æœ‰çš„Difyé…ç½®ç®¡ç†ï¼ˆå·²åœ¨dify_config.pyä¸­å®ç°ï¼‰
# 3. å¤ç”¨ç°æœ‰çš„DifyServiceï¼ˆå·²åœ¨dify_service.pyä¸­å®ç°ï¼‰
# 4. æ— éœ€é¢å¤–çš„DifyAgentManagerï¼Œä¿æŒä»£ç ç®€æ´
```

#### 4.3.3 MCPæœåŠ¡å™¨ä¸»å…¥å£

```python
# app/mcp/v1/server.py
class MCPServer:
    """MCPæœåŠ¡å™¨ä¸»å…¥å£ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰MCPè¯·æ±‚"""
  
    def __init__(self):
        self.registry = MCPServiceRegistry()
        self.middleware_stack = []
        self._register_default_tools()
      
    def _register_default_tools(self):
        """æ³¨å†Œé»˜è®¤çš„MCPå·¥å…·"""
        from .tools.user_profile import UserProfileTool
        from .tools.customer_analysis import CustomerAnalysisTool
        from .tools.conversation_data import ConversationDataTool
      
        self.registry.register_tool("get_user_profile", UserProfileTool)
        self.registry.register_tool("analyze_customer", CustomerAnalysisTool)
        self.registry.register_tool("get_conversation_data", ConversationDataTool)
      
    async def handle_request(self, tool_name: str, params: dict) -> dict:
        """å¤„ç†MCPè¯·æ±‚"""
        try:
            # åº”ç”¨ä¸­é—´ä»¶
            for middleware in self.middleware_stack:
                params = await middleware.process_request(params)
          
            # è·å–å·¥å…·å¹¶æ‰§è¡Œ
            tools = self.registry.get_available_tools()
            if tool_name not in tools:
                return {"error": f"Tool {tool_name} not found or disabled"}
          
            tool_instance = tools[tool_name]["class"]()
            result = await tool_instance.execute(**params)
          
            # åº”ç”¨å“åº”ä¸­é—´ä»¶
            for middleware in reversed(self.middleware_stack):
                result = await middleware.process_response(result)
              
            return result
          
        except Exception as e:
            logger.error(f"MCPè¯·æ±‚å¤„ç†å¤±è´¥: {e}")
            return {"error": str(e)}
```

#### 4.3.4 ç®¡ç†å‘˜é¢æ¿é›†æˆä¸ç›‘æ§

# app/mcp/v1/middleware/monitoring.py

class MCPMonitoringMiddleware:
    """MCPç›‘æ§ä¸­é—´ä»¶ï¼Œè®°å½•è°ƒç”¨ç»Ÿè®¡"""

    def__init__(self):
        self.call_stats = {}
        self.error_stats = {}

    async def process_request(self, params: dict) -> dict:
        """è®°å½•è¯·æ±‚å¼€å§‹"""
        tool_name = params.get('_tool_name')
        if tool_name:
            self.call_stats[tool_name] = self.call_stats.get(tool_name, 0) + 1
        return params

    async def process_response(self, result: dict) -> dict:
        """è®°å½•å“åº”ç»“æœ"""
        if "error" in result:
            tool_name = result.get('_tool_name')
            if tool_name:
                self.error_stats[tool_name] = self.error_stats.get(tool_name, 0) + 1
        return result

    def get_metrics(self) -> dict:
        """è·å–ç›‘æ§æŒ‡æ ‡"""
        return {
            "total_calls": sum(self.call_stats.values()),
            "tool_calls": self.call_stats,
            "error_rates": {
                tool: self.error_stats.get(tool, 0) / self.call_stats.get(tool, 1)
                for tool in self.call_stats.keys()
            },
            "success_rate": 1 - sum(self.error_stats.values()) / max(sum(self.call_stats.values()), 1)
        }

# app/api/v1/endpoints/mcp_dashboard.py

@router.get("/registration-automation/metrics")
async def get_registration_automation_metrics(
    current_user: User = Depends(get_current_admin_user)
):
    """è·å–æ³¨å†Œè‡ªåŠ¨åŒ–æŒ‡æ ‡ï¼ˆç®¡ç†å‘˜é¢æ¿ï¼‰"""
    mcp_server = get_mcp_server()
    monitoring = mcp_server.get_middleware("monitoring")

    return {
        "mcp_metrics": monitoring.get_metrics() if monitoring else {},
        "dify_agent_status": await check_dify_agent_status(),
        "automation_success_rate": await get_automation_success_rate(),
        "daily_registrations": await get_daily_registration_stats(),
        "welcome_message_stats": await get_welcome_message_stats()
    }

#### 4.3.3 MCPåˆ†ç»„æœåŠ¡ä¸è®¤è¯ç®¡ç†

åŸºäºåˆ†ç»„çš„MCPå·¥å…·ç®¡ç†ï¼Œæä¾›å®‰å…¨çš„API Keyæƒé™æ§åˆ¶ï¼š

```python
# app/services/mcp_group_service.py
import secrets
import hashlib
from datetime import datetime

class MCPGroupService:
    """MCPå·¥å…·åˆ†ç»„æœåŠ¡"""
  
    @staticmethod
    async def create_group(db: Session, group_create: MCPGroupCreate, created_by: str) -> dict:
        """åˆ›å»ºMCPå·¥å…·åˆ†ç»„å¹¶ç”ŸæˆAPI Key"""
        # ç”Ÿæˆå®‰å…¨çš„API Key
        api_key = f"mcp_key_{secrets.token_urlsafe(32)}"
  
        group_data = {
            "id": str(uuid4()),
            "name": group_create.name,
            "description": group_create.description,
            "api_key": api_key,  # å®é™…å®ç°ä¸­åº”åŠ å¯†å­˜å‚¨
            "enabled": True,
            "created_by": created_by,
            "created_at": datetime.utcnow(),
            "updated_at": datetime.utcnow()
        }
  
        # ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå…·ä½“å®ç°ä¾æ®ORMï¼‰
        # group = MCPToolGroup(**group_data)
        # db.add(group)
        # db.commit()
  
        logger.info(f"åˆ›å»ºMCPåˆ†ç»„: {group_create.name}, åˆ›å»ºè€…: {created_by}")
        return group_data
  
    @staticmethod
    async def get_group_api_key(db: Session, group_id: str) -> str:
        """è·å–åˆ†ç»„API Keyï¼ˆä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ï¼‰"""
        # ä»æ•°æ®åº“æŸ¥è¯¢API Key
        # group = db.query(MCPToolGroup).filter(MCPToolGroup.id == group_id).first()
        # return group.api_key if group else None
        pass
  
    @staticmethod
    async def regenerate_api_key(db: Session, group_id: str, admin_user_id: str) -> str:
        """é‡æ–°ç”Ÿæˆåˆ†ç»„API Keyï¼ˆå®‰å…¨æ“ä½œï¼‰"""
        new_api_key = f"mcp_key_{secrets.token_urlsafe(32)}"
  
        # æ›´æ–°æ•°æ®åº“ä¸­çš„API Key
        # group = db.query(MCPToolGroup).filter(MCPToolGroup.id == group_id).first()
        # group.api_key = new_api_key
        # group.updated_at = datetime.utcnow()
        # db.commit()
  
        logger.warning(f"é‡æ–°ç”ŸæˆAPI Key: åˆ†ç»„={group_id}, æ“ä½œå‘˜={admin_user_id}")
        return new_api_key

# app/mcp/v1/middleware/mcp_auth.py
class MCPAuthMiddleware:
    """MCPè°ƒç”¨è®¤è¯ä¸­é—´ä»¶"""
  
    def __init__(self, db: Session):
        self.db = db
  
    async def authenticate_request(self, api_key: str, tool_name: str) -> dict:
        """éªŒè¯MCPè°ƒç”¨è¯·æ±‚"""
        try:
            # æŸ¥æ‰¾API Keyå¯¹åº”çš„åˆ†ç»„
            group = await self._find_group_by_api_key(api_key)
            if not group:
                return {"valid": False, "error": "Invalid API Key"}
  
            if not group.get("enabled"):
                return {"valid": False, "error": "Group disabled"}
  
            # æ£€æŸ¥å·¥å…·æ˜¯å¦å±äºè¯¥åˆ†ç»„ä¸”å·²å¯ç”¨
            tool = await self._find_tool_in_group(tool_name, group["id"])
            if not tool:
                return {"valid": False, "error": "Tool not found in group"}
  
            if not tool.get("enabled"):
                return {"valid": False, "error": "Tool disabled"}
  
            return {
                "valid": True,
                "group_id": group["id"],
                "group_name": group["name"],
                "tool_config": tool
            }
  
        except Exception as e:
            logger.error(f"MCPè®¤è¯å¤±è´¥: {e}")
            return {"valid": False, "error": "Authentication failed"}
  
    async def _find_group_by_api_key(self, api_key: str) -> dict:
        """æ ¹æ®API KeyæŸ¥æ‰¾åˆ†ç»„"""
        # ä»æ•°æ®åº“æŸ¥è¯¢åˆ†ç»„ä¿¡æ¯
        # group = db.query(MCPToolGroup).filter(MCPToolGroup.api_key == api_key).first()
        # return group.to_dict() if group else None
        pass
  
    async def _find_tool_in_group(self, tool_name: str, group_id: str) -> dict:
        """æŸ¥æ‰¾åˆ†ç»„å†…çš„å·¥å…·"""
        # tool = db.query(MCPTool).filter(
        #     MCPTool.tool_name == tool_name,
        #     MCPTool.group_id == group_id
        # ).first()
        # return tool.to_dict() if tool else None
        pass

# è¯´æ˜ï¼š
# 1. åŸºäºåˆ†ç»„çš„API Keyç®¡ç†ï¼Œæä¾›ç»†ç²’åº¦æƒé™æ§åˆ¶
# 2. å®‰å…¨çš„API Keyç”Ÿæˆå’ŒéªŒè¯æœºåˆ¶
# 3. å®Œæ•´çš„è®¤è¯ä¸­é—´ä»¶ï¼ŒéªŒè¯Difyè°ƒç”¨çš„åˆæ³•æ€§
# 4. æ“ä½œå®¡è®¡æ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³æ“ä½œ
```

### 4.4 é€šçŸ¥ç³»ç»Ÿè®¾è®¡

#### 4.4.1 é¡¾é—®é€šçŸ¥æµç¨‹

```python
async def notify_consultants(self, user_id: str, conversation_id: str):
    """é€šçŸ¥é¡¾é—®æœ‰æ–°å®¢æˆ·"""
    try:
        # è·å–åœ¨çº¿é¡¾é—®åˆ—è¡¨
        online_consultants = await self._get_online_consultants()
      
        # å‡†å¤‡é€šçŸ¥æ•°æ®
        notification_data = {
            "type": "new_customer",
            "title": "æ–°å®¢æˆ·æ³¨å†Œ",
            "message": f"æ–°å®¢æˆ·å·²æ³¨å†Œå¹¶å¼€å§‹å’¨è¯¢ï¼Œç­‰å¾…é¡¾é—®è®¤é¢†",
            "customer_id": user_id,
            "conversation_id": conversation_id,
            "timestamp": datetime.now().isoformat(),
            "action": "claim_customer"
        }
      
        # é€šè¿‡å¹¿æ’­æœåŠ¡å‘é€é€šçŸ¥
        broadcasting_service = await get_broadcasting_service_dependency(self.db)
      
        for consultant_id in online_consultants:
            await broadcasting_service.send_direct_message(
                user_id=consultant_id,
                message_data=notification_data
            )
      
        # å¦‚æœæ²¡æœ‰åœ¨çº¿é¡¾é—®ï¼Œå‘é€æ¨é€é€šçŸ¥ç»™æ‰€æœ‰é¡¾é—®
        if not online_consultants:
            all_consultants = await self._get_all_consultants()
            for consultant_id in all_consultants:
                await broadcasting_service._send_push_notification(
                    user_id=consultant_id,
                    notification_data={
                        "title": "æ–°å®¢æˆ·ç­‰å¾…æœåŠ¡",
                        "body": "æœ‰æ–°å®¢æˆ·æ³¨å†Œï¼Œè¯·åŠæ—¶å“åº”",
                        "conversation_id": conversation_id
                    }
                )
      
    except Exception as e:
        logger.error(f"é€šçŸ¥é¡¾é—®å¤±è´¥: {e}")
```

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 ç°æœ‰è¡¨ç»“æ„åˆ©ç”¨

å®Œå…¨å¤ç”¨ç°æœ‰çš„æ•°æ®åº“ç»“æ„ï¼š

- **usersè¡¨**ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºMCPæœåŠ¡çš„ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- **conversationsè¡¨**ï¼šä¼šè¯ç®¡ç†ï¼ŒåŒ…å«AIæ§åˆ¶çŠ¶æ€ï¼Œç”¨äºåˆ›å»ºé»˜è®¤ä¼šè¯
- **messagesè¡¨**ï¼šæ¶ˆæ¯å­˜å‚¨ï¼Œæ”¯æŒç»“æ„åŒ–å†…å®¹ï¼Œç”¨äºä¿å­˜æ¬¢è¿æ¶ˆæ¯
- **system_settingsè¡¨**ï¼šç³»ç»Ÿé…ç½®ï¼ˆæ— éœ€æ–°å¢å­—æ®µï¼‰
- **dify_configsè¡¨**ï¼šç°æœ‰Difyé…ç½®è¡¨ï¼ˆé€šè¿‡dify_config.pyç®¡ç†ï¼‰

### 5.2 æ–°å¢MCPç›¸å…³æ•°æ®åº“è¡¨è®¾è®¡

#### 5.2.1 MCPå·¥å…·åˆ†ç»„è¡¨

```sql
CREATE TABLE mcp_tool_groups (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç»„åç§°',
    description TEXT COMMENT 'åˆ†ç»„æè¿°',
    api_key VARCHAR(255) NOT NULL COMMENT 'åˆ†ç»„APIå¯†é’¥',
    enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    created_by VARCHAR(36) COMMENT 'åˆ›å»ºè€…ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_name (name),
    INDEX idx_enabled (enabled),
    INDEX idx_created_by (created_by)
);
```

#### 5.2.2 MCPå·¥å…·é…ç½®è¡¨

```sql
CREATE TABLE mcp_tools (
    id VARCHAR(36) PRIMARY KEY,
    tool_name VARCHAR(100) NOT NULL COMMENT 'å·¥å…·åç§°',
    group_id VARCHAR(36) NOT NULL COMMENT 'æ‰€å±åˆ†ç»„ID',
    version VARCHAR(20) DEFAULT '1.0.0' COMMENT 'å·¥å…·ç‰ˆæœ¬',
    description TEXT COMMENT 'å·¥å…·æè¿°',
    enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    timeout_seconds INT DEFAULT 30 COMMENT 'è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰',
    config_data JSON COMMENT 'å·¥å…·é…ç½®æ•°æ®',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tool_name (tool_name),
    FOREIGN KEY (group_id) REFERENCES mcp_tool_groups(id) ON DELETE CASCADE,
    INDEX idx_group_enabled (group_id, enabled),
    INDEX idx_tool_name (tool_name)
);
```

#### 5.2.3 MCPè°ƒç”¨æ—¥å¿—è¡¨

```sql
CREATE TABLE mcp_call_logs (
    id VARCHAR(36) PRIMARY KEY,
    tool_name VARCHAR(100) NOT NULL COMMENT 'å·¥å…·åç§°',
    group_id VARCHAR(36) NOT NULL COMMENT 'åˆ†ç»„ID',
    caller_app_id VARCHAR(100) COMMENT 'è°ƒç”¨æ–¹åº”ç”¨IDï¼ˆDify AppIDï¼‰',
    request_data JSON COMMENT 'è¯·æ±‚æ•°æ®',
    response_data JSON COMMENT 'å“åº”æ•°æ®',
    success BOOLEAN NOT NULL COMMENT 'æ˜¯å¦æˆåŠŸ',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    duration_ms INT COMMENT 'æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tool_success_time (tool_name, success, created_at),
    INDEX idx_group_time (group_id, created_at),
    INDEX idx_caller_time (caller_app_id, created_at)
);
```

### 5.3 MCPåˆ†ç»„ç®¡ç†é…ç½®æ¶æ„

åŸºäºåˆ†ç»„çš„MCPå·¥å…·ç®¡ç†ï¼Œæ”¯æŒAPI Keyæƒé™æ§åˆ¶å’ŒåŠ¨æ€é…ç½®ï¼š

#### 5.3.1 MCPå·¥å…·åˆ†ç»„ç®¡ç†API

```python
# app/api/v1/endpoints/mcp_config.pyï¼ˆæ–°æ–‡ä»¶ï¼‰

# MCPå·¥å…·åˆ†ç»„ç®¡ç†
@router.get("/groups", response_model=MCPGroupListResponse)
async def get_mcp_groups(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """è·å–MCPå·¥å…·åˆ†ç»„åˆ—è¡¨"""
    try:
        groups = await MCPGroupService.get_all_groups(db)
        return MCPGroupListResponse(
            success=True,
            data=groups,
            message="è·å–MCPåˆ†ç»„åˆ—è¡¨æˆåŠŸ"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"è·å–MCPåˆ†ç»„å¤±è´¥: {str(e)}"
        )

@router.post("/groups", response_model=MCPGroupResponse)
async def create_mcp_group(
    group_create: MCPGroupCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """åˆ›å»ºMCPå·¥å…·åˆ†ç»„"""
    try:
        # åˆ›å»ºåˆ†ç»„å¹¶è‡ªåŠ¨ç”ŸæˆAPI Key
        group = await MCPGroupService.create_group(db, group_create, str(current_user.id))
      
        return MCPGroupResponse(
            success=True,
            data=group,
            message="MCPåˆ†ç»„åˆ›å»ºæˆåŠŸ"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"åˆ›å»ºMCPåˆ†ç»„å¤±è´¥: {str(e)}"
        )

@router.get("/groups/{group_id}/api-key")
async def get_group_api_key(
    group_id: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """æŸ¥çœ‹åˆ†ç»„API Keyï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰"""
    try:
        api_key = await MCPGroupService.get_group_api_key(db, group_id)
        return {
            "success": True,
            "data": {"api_key": api_key},
            "message": "API Keyè·å–æˆåŠŸ"
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"è·å–API Keyå¤±è´¥: {str(e)}"
        )

@router.post("/groups/{group_id}/regenerate-key")
async def regenerate_group_api_key(
    group_id: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """é‡æ–°ç”Ÿæˆåˆ†ç»„API Key"""
    try:
        new_api_key = await MCPGroupService.regenerate_api_key(db, group_id, str(current_user.id))
      
        # è®°å½•å®‰å…¨æ“ä½œæ—¥å¿—
        logger.warning(f"ç®¡ç†å‘˜ {current_user.id} é‡æ–°ç”Ÿæˆäº†åˆ†ç»„ {group_id} çš„API Key")
      
        return {
            "success": True,
            "data": {"api_key": new_api_key},
            "message": "API Keyé‡æ–°ç”ŸæˆæˆåŠŸ"
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"é‡æ–°ç”ŸæˆAPI Keyå¤±è´¥: {str(e)}"
        )

# MCPå·¥å…·é…ç½®ç®¡ç†
@router.get("/tools", response_model=MCPToolListResponse)
async def get_mcp_tools(
    group_id: str = Query(None, description="æŒ‰åˆ†ç»„ç­›é€‰"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """è·å–MCPå·¥å…·åˆ—è¡¨"""
    try:
        tools = await MCPToolService.get_tools(db, group_id=group_id)
        return MCPToolListResponse(
            success=True,
            data=tools,
            message="è·å–MCPå·¥å…·åˆ—è¡¨æˆåŠŸ"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"è·å–MCPå·¥å…·å¤±è´¥: {str(e)}"
        )

@router.put("/tools/{tool_id}")
async def update_mcp_tool(
    tool_id: str,
    tool_update: MCPToolUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    """æ›´æ–°MCPå·¥å…·é…ç½®"""
    try:
        tool = await MCPToolService.update_tool(db, tool_id, tool_update)
      
        # é€šçŸ¥MCPæ³¨å†Œä¸­å¿ƒé…ç½®å˜æ›´
        mcp_registry = get_mcp_registry()
        await mcp_registry.reload_tool_config(tool.tool_name)
      
        logger.info(f"ç®¡ç†å‘˜ {current_user.id} æ›´æ–°äº†MCPå·¥å…· {tool.tool_name}")
      
        return {
            "success": True,
            "data": tool,
            "message": "MCPå·¥å…·æ›´æ–°æˆåŠŸ",
            "effective_immediately": True
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"æ›´æ–°MCPå·¥å…·å¤±è´¥: {str(e)}"
        )

# æ•°æ®æ¨¡å‹
class MCPGroupCreate(BaseModel):
    name: str = Field(..., description="åˆ†ç»„åç§°")
    description: str = Field("", description="åˆ†ç»„æè¿°")

class MCPToolUpdate(BaseModel):
    group_id: str = Field(..., description="æ‰€å±åˆ†ç»„ID")
    enabled: bool = Field(True, description="æ˜¯å¦å¯ç”¨")
    timeout_seconds: int = Field(30, description="è¶…æ—¶æ—¶é—´")
    description: str = Field("", description="å·¥å…·æè¿°")
    config_data: dict = Field({}, description="å·¥å…·é…ç½®")
```

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 å…³é”®æŒ‡æ ‡ç›‘æ§ä¸ç®¡ç†å‘˜é¢æ¿

```python
class RegistrationAutomationMetrics:
    """æ³¨å†Œè‡ªåŠ¨åŒ–æŒ‡æ ‡æ”¶é›†ä¸ç®¡ç†"""
  
    def __init__(self):
        self.daily_stats = {}
        self.real_time_stats = {
            "total_registrations": 0,
            "successful_automations": 0,
            "failed_automations": 0,
            "mcp_calls": 0,
            "dify_agent_calls": 0,
            "average_response_time": 0
        }
  
    async def record_automation_step(
        self,
        user_id: str,
        step: str,  # 'conversation_created', 'mcp_called', 'dify_triggered', 'welcome_sent', 'consultants_notified'
        success: bool,
        duration_ms: int,
        error_message: str = None
    ):
        """è®°å½•è‡ªåŠ¨åŒ–æ­¥éª¤æŒ‡æ ‡"""
        # æ›´æ–°å®æ—¶ç»Ÿè®¡
        if step == "welcome_sent" and success:
            self.real_time_stats["successful_automations"] += 1
        elif step == "welcome_sent" and not success:
            self.real_time_stats["failed_automations"] += 1
      
        if step == "mcp_called":
            self.real_time_stats["mcp_calls"] += 1
        elif step == "dify_triggered":
            self.real_time_stats["dify_agent_calls"] += 1
          
        # æ›´æ–°å¹³å‡å“åº”æ—¶é—´
        self._update_average_response_time(duration_ms)
      
        # è®°å½•æ—¥å¿—
        logger.info(f"æ³¨å†Œè‡ªåŠ¨åŒ–æŒ‡æ ‡: user_id={user_id}, step={step}, "
                   f"success={success}, duration={duration_ms}ms")
      
        if not success and error_message:
            logger.error(f"æ³¨å†Œè‡ªåŠ¨åŒ–å¤±è´¥: user_id={user_id}, step={step}, "
                        f"error={error_message}")
  
    def get_admin_dashboard_metrics(self) -> dict:
        """è·å–ç®¡ç†å‘˜é¢æ¿æŒ‡æ ‡"""
        success_rate = 0
        if self.real_time_stats["successful_automations"] + self.real_time_stats["failed_automations"] > 0:
            success_rate = self.real_time_stats["successful_automations"] / (
                self.real_time_stats["successful_automations"] + self.real_time_stats["failed_automations"]
            )
      
        return {
            "success_rate": success_rate,
            "total_automations": self.real_time_stats["successful_automations"] + self.real_time_stats["failed_automations"],
            "mcp_call_count": self.real_time_stats["mcp_calls"],
            "dify_call_count": self.real_time_stats["dify_agent_calls"],
            "average_response_time": self.real_time_stats["average_response_time"],
            "daily_trends": self._get_daily_trends()
        }

# ç®¡ç†å‘˜é¢æ¿APIç«¯ç‚¹
@router.get("/admin/registration-automation/dashboard")
async def get_registration_automation_dashboard(
    current_user: User = Depends(get_current_admin_user)
):
    """è·å–æ³¨å†Œè‡ªåŠ¨åŒ–ç®¡ç†é¢æ¿æ•°æ®"""
    metrics = get_registration_metrics()
  
    return {
        "automation_metrics": metrics.get_admin_dashboard_metrics(),
        "mcp_server_status": await get_mcp_server_status(),
        "dify_agent_status": await get_dify_agent_status(),
        "recent_errors": await get_recent_automation_errors(),
        "system_health": {
            "mcp_response_time": await check_mcp_response_time(),
            "dify_response_time": await check_dify_response_time(),
            "database_status": await check_database_health()
        }
    }
```

### 6.2 æ—¥å¿—æ ‡å‡†

```python
# æˆåŠŸæ—¥å¿—ç¤ºä¾‹
logger.info(f"ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–å¼€å§‹: user_id={user_id}, username={username}")
logger.info(f"é»˜è®¤ä¼šè¯åˆ›å»ºæˆåŠŸ: user_id={user_id}, conversation_id={conversation_id}")
logger.info(f"MCPæœåŠ¡è°ƒç”¨æˆåŠŸ: user_id={user_id}, è·å–ç”¨æˆ·ä¿¡æ¯å®Œæˆ")
logger.info(f"Dify Agentæ¬¢è¿æ¶ˆæ¯ç”ŸæˆæˆåŠŸ: user_id={user_id}, message_id={message_id}")
logger.info(f"é¡¾é—®é€šçŸ¥å‘é€å®Œæˆ: user_id={user_id}, é€šçŸ¥é¡¾é—®æ•°é‡={consultant_count}")

# é”™è¯¯æ—¥å¿—ç¤ºä¾‹
logger.error(f"ä¼šè¯åˆ›å»ºå¤±è´¥: user_id={user_id}, error={error_message}")
logger.error(f"MCPæœåŠ¡è°ƒç”¨å¤±è´¥: user_id={user_id}, error={error_message}")
logger.warning(f"Dify Agentä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ¬¢è¿æ¶ˆæ¯: user_id={user_id}")
```

## 7. æµ‹è¯•ç­–ç•¥

### 7.1 å•å…ƒæµ‹è¯•

```python
class TestRegistrationAutomation(TestCase):
  
    async def test_create_default_conversation(self):
        """æµ‹è¯•åˆ›å»ºé»˜è®¤ä¼šè¯"""
        pass
  
    async def test_mcp_service_success(self):
        """æµ‹è¯•MCPæœåŠ¡è°ƒç”¨æˆåŠŸåœºæ™¯"""
        pass
  
    async def test_dify_agent_welcome_generation(self):
        """æµ‹è¯•Dify Agentæ¬¢è¿æ¶ˆæ¯ç”Ÿæˆ"""
        pass
  
    async def test_mcp_dify_fallback(self):
        """æµ‹è¯•MCP/DifyæœåŠ¡å¤±è´¥æ—¶çš„å›é€€æœºåˆ¶"""
        pass
  
    async def test_notify_consultants(self):
        """æµ‹è¯•é¡¾é—®é€šçŸ¥åŠŸèƒ½"""
        pass
  
    async def test_retry_mechanism(self):
        """æµ‹è¯•é‡è¯•æœºåˆ¶"""
        pass
```

### 7.2 é›†æˆæµ‹è¯•

```python
async def test_full_registration_flow(self):
    """æµ‹è¯•å®Œæ•´æ³¨å†Œè‡ªåŠ¨åŒ–æµç¨‹"""
    # 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    # 2. è§¦å‘æ³¨å†Œè‡ªåŠ¨åŒ–
    # 3. éªŒè¯ä¼šè¯åˆ›å»º
    # 4. éªŒè¯æ¬¢è¿æ¶ˆæ¯
    # 5. éªŒè¯é¡¾é—®é€šçŸ¥
    pass
```

### 7.3 æ€§èƒ½æµ‹è¯•

- **å¹¶å‘æ³¨å†Œæµ‹è¯•**ï¼šæ¨¡æ‹Ÿ100ä¸ªç”¨æˆ·åŒæ—¶æ³¨å†Œ
- **MCP/DifyæœåŠ¡å‹åŠ›æµ‹è¯•**ï¼šæµ‹è¯•MCPæœåŠ¡å’ŒDify Agentåœ¨é«˜å¹¶å‘ä¸‹çš„å“åº”èƒ½åŠ›
- **ç½‘ç»œæ•…éšœæµ‹è¯•**ï¼šæ¨¡æ‹Ÿç½‘ç»œä¸­æ–­æ—¶çš„é‡è¯•æœºåˆ¶

## 8. éƒ¨ç½²æ–¹æ¡ˆ

### 8.1 ç®¡ç†å‘˜ç•Œé¢é…ç½®ç®¡ç†

æ‰€æœ‰é…ç½®å‡é€šè¿‡ç®¡ç†å‘˜ç•Œé¢è¿›è¡Œç®¡ç†ï¼Œæ”¯æŒå®æ—¶é…ç½®å’Œå³æ—¶ç”Ÿæ•ˆï¼š

#### 8.1.1 MCPå·¥å…·åˆ†ç»„ç®¡ç†ç•Œé¢

```
ğŸ“Š MCPåˆ†ç»„ç®¡ç†é¢æ¿
â”œâ”€â”€ ğŸ“‚ åˆ†ç»„ç®¡ç†
â”‚   â”œâ”€â”€ åˆ›å»ºæ–°åˆ†ç»„
â”‚   â”œâ”€â”€ åˆ†ç»„å¯ç”¨/ç¦ç”¨
â”‚   â”œâ”€â”€ åˆ†ç»„æè¿°ç¼–è¾‘
â”‚   â””â”€â”€ æŸ¥çœ‹API Keyï¼ˆå®‰å…¨æ“ä½œï¼‰
â”œâ”€â”€ ğŸ”‘ API Keyç®¡ç†
â”‚   â”œâ”€â”€ ç”Ÿæˆæ–°API Key
â”‚   â”œâ”€â”€ é‡æ–°ç”ŸæˆAPI Key
â”‚   â”œâ”€â”€ API Keyæƒé™æ§åˆ¶
â”‚   â””â”€â”€ ä½¿ç”¨æƒ…å†µç»Ÿè®¡
â”œâ”€â”€ ğŸ› ï¸ å·¥å…·é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ å·¥å…·åˆ†ç»„åˆ†é…
â”‚   â”œâ”€â”€ å·¥å…·å¯ç”¨/ç¦ç”¨
â”‚   â”œâ”€â”€ è¶…æ—¶æ—¶é—´é…ç½®
â”‚   â””â”€â”€ å·¥å…·æè¿°ç¼–è¾‘
â””â”€â”€ ğŸ“ˆ è°ƒç”¨ç›‘æ§
    â”œâ”€â”€ åˆ†ç»„è°ƒç”¨ç»Ÿè®¡
    â”œâ”€â”€ å·¥å…·ä½¿ç”¨é¢‘ç‡
    â”œâ”€â”€ é”™è¯¯ç‡ç›‘æ§
    â””â”€â”€ æ€§èƒ½æŒ‡æ ‡å±•ç¤º
```

#### 8.1.2 æ³¨å†Œè‡ªåŠ¨åŒ–é…ç½®ç•Œé¢

```
âš™ï¸ æ³¨å†Œè‡ªåŠ¨åŒ–è®¾ç½®é¢æ¿
â”œâ”€â”€ ğŸ”„ é‡è¯•æœºåˆ¶é…ç½®
â”‚   â”œâ”€â”€ æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®
â”‚   â”œâ”€â”€ é‡è¯•é—´éš”é…ç½®
â”‚   â””â”€â”€ å¤±è´¥å¤„ç†ç­–ç•¥
â”œâ”€â”€ ğŸ“¢ é€šçŸ¥è®¾ç½®
â”‚   â”œâ”€â”€ é¡¾é—®é€šçŸ¥å¯ç”¨/ç¦ç”¨
â”‚   â”œâ”€â”€ é€šçŸ¥æ–¹å¼é€‰æ‹©
â”‚   â””â”€â”€ é€šçŸ¥æ¨¡æ¿ç®¡ç†
â””â”€â”€ ğŸ“‹ ä¸šåŠ¡è§„åˆ™é…ç½®
    â”œâ”€â”€ é»˜è®¤ä¼šè¯è®¾ç½®
    â”œâ”€â”€ æ¬¢è¿æ¶ˆæ¯ç­–ç•¥
    â””â”€â”€ å®¢æˆ·åˆ†é…è§„åˆ™
```

### 8.2 é…ç½®ç”Ÿæ•ˆæœºåˆ¶ä¸åŠŸèƒ½å¼€å…³

é€šè¿‡MCPæœåŠ¡æ³¨å†Œä¸å‘ç°æœºåˆ¶å®ç°åŠ¨æ€åŠŸèƒ½æ§åˆ¶ï¼š

#### 8.2.1 é…ç½®å®æ—¶ç”Ÿæ•ˆæµç¨‹

```mermaid
graph TD
    A[ç®¡ç†å‘˜ç•Œé¢ä¿®æ”¹é…ç½®] --> B[é…ç½®APIéªŒè¯]
    B --> C[ä¿å­˜åˆ°æ•°æ®åº“]
    C --> D[æ›´æ–°å†…å­˜ç¼“å­˜]
    D --> E[é€šçŸ¥MCPæ³¨å†Œä¸­å¿ƒ]
    E --> F[é…ç½®ç«‹å³ç”Ÿæ•ˆ]
    F --> G[è¿”å›æˆåŠŸçŠ¶æ€]
  
    style A fill:#e1f5fe
    style F fill:#e8f5e8
    style G fill:#fff3e0
```

#### 8.2.2 æ™ºèƒ½åŠŸèƒ½å¼€å…³å®ç°

```python
@router.post("/register")
async def register(...):
    userResponse = await user_service.create(db, obj_in=user_in)
  
    # é€šè¿‡MCPæœåŠ¡æ³¨å†Œä¸­å¿ƒæ£€æŸ¥åŠŸèƒ½çŠ¶æ€
    mcp_registry = get_mcp_registry()
    if await mcp_registry.is_service_enabled("registration_automation"):
        # æ£€æŸ¥å…·ä½“çš„MCPå·¥å…·æ˜¯å¦å¯ç”¨
        if await mcp_registry.is_tool_available("get_user_profile"):
            background_tasks.add_task(
                handle_registration_automation,
                user_id=str(userResponse.id),
                user_info=userResponse.dict()
            )
        else:
            logger.warning("ç”¨æˆ·ä¿¡æ¯MCPå·¥å…·ä¸å¯ç”¨ï¼Œè·³è¿‡æ³¨å†Œè‡ªåŠ¨åŒ–")
  
    return userResponse

class MCPServiceRegistry:
    """MCPæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæä¾›åŠ¨æ€åŠŸèƒ½å¼€å…³"""
  
    async def is_service_enabled(self, service_name: str) -> bool:
        """æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨ï¼ˆåŸºäºç®¡ç†å‘˜é…ç½®ï¼‰"""
        config = await self._get_service_config(service_name)
        return config.get("enabled", False)
  
    async def is_tool_available(self, tool_name: str) -> bool:
        """æ£€æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨ä¸”å¯ç”¨"""
        if tool_name not in self.tools:
            return False
        return self.status.get(tool_name) == "enabled"
```

### 8.3 ç°åº¦å‘å¸ƒç­–ç•¥

1. **é˜¶æ®µ1**ï¼šå†…éƒ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. **é˜¶æ®µ2**ï¼šç”Ÿäº§ç¯å¢ƒ10%ç”¨æˆ·
3. **é˜¶æ®µ3**ï¼šç”Ÿäº§ç¯å¢ƒ50%ç”¨æˆ·
4. **é˜¶æ®µ4**ï¼šå…¨é‡å‘å¸ƒ

## 9. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 9.1 æŠ€æœ¯é£é™©

| é£é™©               | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥           |
| ------------------ | ---- | ---- | ------------------ |
| MCP/DifyæœåŠ¡ä¸å¯ç”¨ | ä¸­   | ä½   | å›é€€åˆ°é»˜è®¤æ¨¡æ¿æ¶ˆæ¯ |
| æ•°æ®åº“è¿æ¥å¤±è´¥     | é«˜   | ä½   | é‡è¯•æœºåˆ¶+å‘Šè­¦      |
| æ¶ˆæ¯å¹¿æ’­å¤±è´¥       | ä¸­   | ä¸­   | å¼‚æ­¥é‡è¯•+æ—¥å¿—è®°å½•  |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™©           | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥          |
| -------------- | ---- | ---- | ----------------- |
| ç”¨æˆ·ä½“éªŒä¸ä½³   | ä¸­   | ä½   | A/Bæµ‹è¯•+ç”¨æˆ·åé¦ˆ  |
| é¡¾é—®å“åº”ä¸åŠæ—¶ | ä¸­   | ä¸­   | å¤šçº§é€šçŸ¥+å‡çº§æœºåˆ¶ |
| ç³»ç»Ÿè´Ÿè½½è¿‡é«˜   | é«˜   | ä½   | é™æµ+ç†”æ–­æœºåˆ¶     |

## 10. æˆåŠŸæŒ‡æ ‡

### 10.1 æŠ€æœ¯æŒ‡æ ‡ï¼ˆç®¡ç†å‘˜é¢æ¿ç›‘æ§ï¼‰

- **è‡ªåŠ¨åŒ–æˆåŠŸç‡**ï¼šâ‰¥ 99%ï¼ˆå®æ—¶ç›‘æ§ï¼Œå¼‚å¸¸å‘Šè­¦ï¼‰
- **å¹³å‡å“åº”æ—¶é—´**ï¼šâ‰¤ 3ç§’ï¼ˆåŒ…å«MCPè°ƒç”¨+Difyå¤„ç†æ—¶é—´ï¼‰
- **MCPæœåŠ¡å¯ç”¨æ€§**ï¼šâ‰¥ 99.9%ï¼ˆå“åº”æ—¶é—´<500msï¼‰
- **Dify Agentè°ƒç”¨æˆåŠŸç‡**ï¼šâ‰¥ 95%ï¼ˆå«é‡è¯•æœºåˆ¶ï¼‰
- **é¡¾é—®é€šçŸ¥åˆ°è¾¾ç‡**ï¼šâ‰¥ 99%ï¼ˆWebSocket + æ¨é€åŒé‡ä¿éšœï¼‰

### 10.2 ä¸šåŠ¡æŒ‡æ ‡ï¼ˆç®¡ç†å‘˜é¢æ¿å±•ç¤ºï¼‰

- **æ–°ç”¨æˆ·é¦–æ¬¡å“åº”æ—¶é—´**ï¼šâ‰¤ 5åˆ†é’Ÿï¼ˆå«AIæ¬¢è¿æ¶ˆæ¯æ—¶é—´ï¼‰
- **æ³¨å†Œåˆ°é¦–æ¬¡å¯¹è¯çš„è½¬åŒ–ç‡**ï¼šâ‰¥ 80%ï¼ˆ7æ—¥ç•™å­˜ç‡ç›‘æ§ï¼‰
- **ç”¨æˆ·æ»¡æ„åº¦**ï¼šâ‰¥ 4.5/5.0ï¼ˆåŸºäºæ¬¢è¿æ¶ˆæ¯åé¦ˆï¼‰
- **é¡¾é—®è®¤é¢†æ–°å®¢æˆ·çš„å“åº”æ—¶é—´**ï¼šâ‰¤ 10åˆ†é’Ÿï¼ˆå·¥ä½œæ—¶é—´å†…ï¼‰

### 10.3 ç®¡ç†å‘˜é¢æ¿ç›‘æ§é¡¹

- **å®æ—¶æ³¨å†Œé‡ç›‘æ§**ï¼šå½“æ—¥æ³¨å†Œæ•°é‡å’Œè¶‹åŠ¿å›¾è¡¨
- **è‡ªåŠ¨åŒ–æµç¨‹å¥åº·åº¦**ï¼šå„æ­¥éª¤æˆåŠŸç‡å’Œå“åº”æ—¶é—´
- **MCPå·¥å…·è°ƒç”¨ç»Ÿè®¡**ï¼šå„å·¥å…·ä½¿ç”¨é¢‘ç‡å’Œé”™è¯¯ç‡
- **Dify Agentæ€§èƒ½ç›‘æ§**ï¼šè°ƒç”¨æ¬¡æ•°ã€æˆåŠŸç‡ã€å¹³å‡å“åº”æ—¶é—´
- **é”™è¯¯æ—¥å¿—åˆ†æ**ï¼šé”™è¯¯ç±»å‹åˆ†å¸ƒå’Œé¢‘æ¬¡ç»Ÿè®¡
- **ç³»ç»Ÿèµ„æºç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ

## 11. åç»­è¿­ä»£è®¡åˆ’

### 11.1 V1.1 ç‰ˆæœ¬ï¼ˆé¢„è®¡1ä¸ªæœˆåï¼‰

- ç”¨æˆ·å…´è¶£æ ‡ç­¾åˆ†æ
- æ™ºèƒ½é¡¾é—®åŒ¹é…ç®—æ³•
- æ¬¢è¿æ¶ˆæ¯ä¸ªæ€§åŒ–ç¨‹åº¦æå‡

### 11.2 V1.2 ç‰ˆæœ¬ï¼ˆé¢„è®¡2ä¸ªæœˆåï¼‰

- å¤šè¯­è¨€æ¬¢è¿æ¶ˆæ¯æ”¯æŒ
- ç”¨æˆ·è¡Œä¸ºæ•°æ®æ”¶é›†
- æ™ºèƒ½æ¨èç³»ç»Ÿé›†æˆ

### 11.3 V2.0 ç‰ˆæœ¬ï¼ˆé¢„è®¡3ä¸ªæœˆåï¼‰

- å®Œæ•´çš„å®¢æˆ·ç”»åƒç³»ç»Ÿ
- æ™ºèƒ½å®¢æœæœºå™¨äººå‡çº§
- å…¨æ¸ é“ç”¨æˆ·ä½“éªŒç»Ÿä¸€

## 12. æ¶æ„è®¾è®¡æ€»ç»“

### 12.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

åŸºäºç°æœ‰çš„**AI Gatewayä¼ä¸šçº§æ¶æ„**ï¼Œé‡‡ç”¨**MCPæœåŠ¡ä½“ç³»**å®ç°ç”¨æˆ·æ³¨å†Œè‡ªåŠ¨åŒ–ï¼Œå……åˆ†åˆ©ç”¨å·²å®Œæˆçš„Difyé›†æˆèƒ½åŠ›ã€‚

### 12.2 å…³é”®æŠ€æœ¯å†³ç­–

1. **MCPä¸APIåŒçº§è®¾è®¡**ï¼šMCPæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸APIæœåŠ¡åŒçº§ç®¡ç†
2. **å¤ç”¨AI Gatewayæ¶æ„**ï¼šå……åˆ†åˆ©ç”¨ç°æœ‰çš„Difyé›†æˆå’Œç†”æ–­é™çº§æœºåˆ¶
3. **ç®¡ç†å‘˜ç•Œé¢é©±åŠ¨é…ç½®**ï¼šæ‘’å¼ƒç¯å¢ƒå˜é‡ï¼Œå…¨éƒ¨é€šè¿‡Webç•Œé¢ç®¡ç†é…ç½®
4. **é…ç½®å®æ—¶ç”Ÿæ•ˆæœºåˆ¶**ï¼šé…ç½®å˜æ›´æ— éœ€é‡å¯ï¼Œæ”¯æŒçƒ­æ›´æ–°å’Œå³æ—¶ç”Ÿæ•ˆ
5. **MCPæœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼šé€šè¿‡æ³¨å†Œä¸­å¿ƒå®ç°æ™ºèƒ½åŠŸèƒ½å¼€å…³å’ŒæœåŠ¡å‘ç°
6. **æœ€å°åŒ–æ•°æ®åº“å˜æ›´**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„ï¼Œä¿æŒæ¶æ„ç¨³å®šæ€§
7. **ç®¡ç†å‘˜é¢æ¿é›†æˆ**ï¼šæ‰€æœ‰æŒ‡æ ‡å’Œé…ç½®ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºè¿ç»´ç›‘æ§

### 12.3 å¯æ‰©å±•æ€§ä¿éšœ

- **MCPå·¥å…·æ¨¡å—åŒ–**ï¼šæ”¯æŒåŠ¨æ€æ³¨å†Œã€ç‰ˆæœ¬ç®¡ç†ã€å¯ç”¨/ç¦ç”¨
- **Agenté…ç½®çµæ´»æ€§**ï¼šæ”¯æŒå¤šä¸ªDify Agentçš„é…ç½®å’Œåˆ‡æ¢
- **ç›‘æ§ä½“ç³»å®Œæ•´**ï¼šä»MCPè°ƒç”¨åˆ°ä¸šåŠ¡æŒ‡æ ‡çš„å…¨é“¾è·¯ç›‘æ§
- **ä¸­é—´ä»¶æ¶æ„**ï¼šæ”¯æŒè®¤è¯ã€æ—¥å¿—ã€ç›‘æ§ç­‰ä¸­é—´ä»¶æ’ä»¶

### 12.4 è¿ç»´å‹å¥½æ€§

- **é›¶åœæœºéƒ¨ç½²**ï¼šMCPæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸å½±å“ç°æœ‰ä¸šåŠ¡
- **Webç•Œé¢é…ç½®**ï¼šæ‰€æœ‰é…ç½®é€šè¿‡ç®¡ç†å‘˜ç•Œé¢æ“ä½œï¼Œæ— éœ€æœåŠ¡å™¨ç™»å½•
- **é…ç½®å³æ—¶ç”Ÿæ•ˆ**ï¼šé…ç½®å˜æ›´å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ä»»ä½•æœåŠ¡
- **å¯è§†åŒ–ç®¡ç†**ï¼šå·¥å…·çŠ¶æ€ã€Agenté…ç½®ã€ä¸šåŠ¡è§„åˆ™ç­‰ç»Ÿä¸€å¯è§†åŒ–ç®¡ç†
- **å®¡è®¡è¿½è¸ª**ï¼šå®Œæ•´çš„é…ç½®å˜æ›´å†å²å’Œæ“ä½œè€…è®°å½•
- **æ•…éšœè‡ªæ„ˆ**ï¼šå®Œå–„çš„é‡è¯•æœºåˆ¶å’Œé™çº§ç­–ç•¥
- **å®æ—¶ç›‘æ§**ï¼šç®¡ç†å‘˜é¢æ¿å®æ—¶å±•ç¤ºç³»ç»Ÿå¥åº·çŠ¶æ€å’Œé…ç½®çŠ¶æ€

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.2**æ›´æ–°æ—¶é—´**ï¼š2025å¹´1æœˆ**ä¸»è¦å˜æ›´**ï¼šé‡‡ç”¨åŸºäºåˆ†ç»„çš„MCPå·¥å…·ç®¡ç†æœºåˆ¶ï¼Œå¢å¼ºå®‰å…¨æ€§å’Œæƒé™æ§åˆ¶**å…³é”®æ”¹è¿›**ï¼š

- MCPå·¥å…·åˆ†ç»„ç®¡ç†ï¼Œæ”¯æŒAPI Keyæƒé™æ§åˆ¶
- å®Œæ•´çš„æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆå·¥å…·åˆ†ç»„ã€å·¥å…·é…ç½®ã€è°ƒç”¨æ—¥å¿—ï¼‰
- å®‰å…¨çš„API Keyç”Ÿæˆå’ŒéªŒè¯æœºåˆ¶
- å¤ç”¨ç°æœ‰Difyé…ç½®ç®¡ç†ï¼Œé¿å…é‡å¤å¼€å‘
- ç§»é™¤ä¸å¿…è¦çš„Dify Agenté…ç½®ç•Œé¢è®¾è®¡

**è´Ÿè´£äºº**ï¼šæŠ€æœ¯å›¢é˜Ÿ
**å®¡æ ¸çŠ¶æ€**ï¼šå¾…å®¡æ ¸
