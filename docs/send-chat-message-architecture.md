# 🏗️ 消息发送架构设计（重构版）

### 📋 核心组件职责

#### 1. **MessageInput.tsx** - 消息输入协调器

```typescript
职责：
✅ 统一管理所有类型的消息输入
✅ 创建消息对象（createTextMessage、createImageMessage、createVoiceMessage、createFileMessage）
✅ 协调图片预览和文字输入
✅ 通过 onSendMessage 接口向上传递消息
✅ 直接处理HTTP发送（不使用WebSocket）

特点：
- 单一发送入口：文字和图片通过统一的发送按钮
- 类型统一：统一的消息创建逻辑
- 状态管理：管理发送状态和错误处理
- HTTP优先：所有消息使用HTTP接口发送
```

#### 2. **MediaPreview.tsx** - 媒体预览处理器

```typescript
职责：
✅ 专注于媒体文件的预览展示
✅ 提供删除预览的功能
✅ 不参与消息发送逻辑

设计原则：
- 关注点分离：只管预览，不管发送
- 简化界面：图片预览只有删除按钮，无发送按钮
- 状态管理：管理预览状态，不管发送状态
```

#### 3. **useMediaUpload.ts** - 媒体状态管理

```typescript
职责：
✅ 管理图片和语音的预览状态
✅ 处理文件选择和本地预览
✅ 提供状态清理方法

特点：
- 纯状态管理：不涉及业务逻辑
- 可复用：可在多个组件中使用
- 简洁API：清晰的状态和操作方法
```

#### 4. **ChatMessage.tsx** - 消息显示器

```typescript
职责：
✅ 根据消息类型渲染不同的显示效果
✅ 处理消息状态（pending、sent、failed）
✅ 提供消息操作（重试、删除、撤销、标记重点）
✅ 支持失败消息的重新发送

特点：
- 多态显示：支持文本、图片、语音、文件等类型
- 状态驱动：根据消息状态展示不同UI
- 重试机制：失败消息可以重新发送
- 移除自动发送：pending消息不再自动发送
```

### 🔄 数据流设计（重构版）

#### **发送流程**

```
1. 用户输入 → 2. 统一处理 → 3. HTTP发送 → 4. 状态更新 → 5. 本地显示 → 6. 错误重试
```

#### **具体流程示例**

**📝 纯文本消息：**

```
用户输入文字 → 点击发送 → createTextMessage() → HTTP发送 → 
立即加入本地列表 → 根据结果更新状态 → ChatMessage显示
```

**🖼️ 图片消息（新逻辑）：**

```
用户选择图片 → 图片预览（删除按钮） → 用户输入文字（可选） → 
点击发送 → 上传图片文件 → createImageMessage()（包含文字） → 
HTTP发送 → 立即加入本地列表 → 根据结果更新状态 → 
清理预览状态 → ChatMessage显示
```

**🎵 语音消息：**

```
用户录音 → useRecording管理录音 → MediaPreview预览 → 
点击语音发送 → 上传到存储 → createVoiceMessage() → 
HTTP发送 → ChatMessage显示
```

#### **重试流程：**

```
用户点击失败消息的重试按钮 → 更新状态为pending → 
HTTP重新发送 → 根据结果更新状态 → 刷新显示
```

### 🔧 重构要点

#### **1. 图片发送重构**

- ❌ 移除预览区的"发送"按钮
- ✅ 图片右下角添加删除小'X'按钮
- ✅ 用户可在输入框输入文字后统一发送
- ✅ 图片和文字构造为单个媒体消息
- ✅ 支持纯图片发送（不带文字）

#### **2. 发送方式重构**

- ❌ 不使用WebSocket发送
- ✅ 只使用HTTP接口发送
- ✅ 立即添加到本地消息列表
- ✅ 根据HTTP响应结果设置消息状态

#### **3. 状态管理重构**

- ❌ 移除pending消息的自动发送逻辑
- ✅ 消息创建时设置canRetry=true
- ✅ 失败消息显示重试按钮
- ✅ 支持手动重试发送

### 🎨 设计原则

#### **1. 用户体验优先**

- 统一发送入口：图片和文字一起发送
- 即时反馈：立即显示消息，异步更新状态
- 错误处理：失败消息可重试，不丢失用户输入

#### **2. 简化界面**

- 减少操作步骤：不需要单独发送图片
- 直观预览：图片预览清晰，删除操作简单
- 状态明确：pending/sent/failed状态清晰显示

#### **3. 可靠性保证**

- HTTP发送：更稳定的网络请求
- 错误重试：网络问题可以重新发送
- 状态同步：本地状态与服务器同步

### 🎯 架构优势（重构版）

1. **✅ 用户体验更佳**：图片和文字统一发送，操作简单
2. **✅ 错误处理完善**：失败消息可重试，不丢失内容
3. **✅ 网络稳定性好**：HTTP发送比WebSocket更稳定
4. **✅ 界面简洁**：减少了不必要的发送按钮
5. **✅ 状态管理清晰**：立即本地显示，异步状态更新
6. **✅ 代码简化**：移除了复杂的pending自动发送逻辑

这个重构确保了图片发送功能的**用户友好性**、**可靠性**和**代码可维护性**的完美平衡！🚀

### 📦 文件结构

```
web/src/
├── components/chat/
│   ├── MessageInput.tsx      # 消息输入协调器
│   ├── MediaPreview.tsx      # 媒体预览处理器
│   ├── ChatMessage.tsx       # 消息显示器
│   ├── FileMessage.tsx       # 文件消息显示
│   └── RecordingControls.tsx # 录音控制
├── hooks/
│   ├── useMediaUpload.ts     # 媒体上传状态管理
│   └── useRecording.ts       # 录音状态管理
├── service/
│   ├── fileService.ts        # 文件服务
│   └── chatService.ts        # 聊天服务
├── utils/
│   └── messageUtils.ts       # 消息工具函数
└── types/
    └── chat.ts               # 类型定义
```

### 🎯 架构优势

1. **✅ 高内聚低耦合**：组件职责清晰，依赖关系简单
2. **✅ 易于测试**：每个组件都可以独立测试
3. **✅ 易于扩展**：新增消息类型只需添加对应的创建函数
4. **✅ 用户体验一致**：统一的错误处理和状态提示
5. **✅ 代码复用**：工具函数和状态管理可复用
6. **✅ 类型安全**：完整的 TypeScript 类型支持

这个架构确保了消息发送功能的**可维护性**、**可扩展性**和**用户体验**的完美平衡！🚀
