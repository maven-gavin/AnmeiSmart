# Agent æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æˆåŠŸå®ç°äº†Agentç³»ç»Ÿçš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œä½¿ç”¨æˆ·å¯ä»¥åœ¨Agentå¯¹è¯å‰é€šè¿‡è¡¨å•ä¸Šä¼ æ–‡ä»¶åˆ°DifyæœåŠ¡å™¨ï¼Œå¹¶å°†æ–‡ä»¶ä½œä¸ºè¾“å…¥å‚æ•°ä¼ é€’ç»™Agentã€‚

## ğŸ¯ å®ç°ç›®æ ‡

1. âœ… åˆ›å»º Agent æ–‡ä»¶ä¸Šä¼ æœåŠ¡
2. âœ… æ‰©å±•å¯¹è¯æœåŠ¡æ”¯æŒ inputs å‚æ•°
3. âœ… ä¿®æ”¹ useAgentChat Hook æ”¯æŒè¡¨å•æ•°æ®
4. âœ… é›†æˆæ–‡ä»¶ä¸Šä¼ åˆ°ç”¨æˆ·è¾“å…¥è¡¨å•
5. âœ… æ›´æ–°ç±»å‹å®šä¹‰

## ğŸ“ æ–‡ä»¶å˜æ›´åˆ—è¡¨

### 1. æ–°å¢æ–‡ä»¶

#### `web/src/service/agentFileService.ts`
- **åŠŸèƒ½**: Agent æ–‡ä»¶ä¸Šä¼ æœåŠ¡
- **ä¸»è¦æ–¹æ³•**:
  - `uploadAgentFile(agentConfigId, file)`: ä¸Šä¼ å•ä¸ªæ–‡ä»¶åˆ°Dify
  - `uploadAgentFiles(agentConfigId, files)`: æ‰¹é‡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶åˆ°Dify
- **è¿”å›å€¼**: Difyçš„æ–‡ä»¶IDï¼ˆupload_file_idï¼‰

### 2. ä¿®æ”¹æ–‡ä»¶

#### `web/src/service/agentChatService.ts`
- **å˜æ›´**: `sendAgentMessage` å‡½æ•°æ–°å¢ `inputs` å‚æ•°
- **ç”¨é€”**: æ”¯æŒå°†è¡¨å•æ•°æ®ï¼ˆåŒ…æ‹¬æ–‡ä»¶IDï¼‰ä¼ é€’ç»™Dify

#### `web/src/hooks/useAgentChat.ts`
- **å˜æ›´**: `sendMessage` å‡½æ•°æ–°å¢ `inputs` å‚æ•°
- **ç”¨é€”**: ä»UIå±‚æ¥æ”¶è¡¨å•æ•°æ®å¹¶ä¼ é€’ç»™æœåŠ¡å±‚

#### `web/src/components/agents/UserInputForm.tsx`
- **å˜æ›´**:
  1. æ–°å¢ `agentConfigId` å±æ€§ï¼ˆå¿…éœ€ï¼‰
  2. æ–°å¢ `uploading` çŠ¶æ€ç®¡ç†
  3. `handleSubmit` æ”¹ä¸ºå¼‚æ­¥å‡½æ•°
  4. å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘ï¼š
     - å•æ–‡ä»¶å­—æ®µ: ä¸Šä¼ å¹¶æ›¿æ¢ä¸ºDifyæ–‡ä»¶ID
     - å¤šæ–‡ä»¶å­—æ®µ: æ‰¹é‡ä¸Šä¼ å¹¶æ›¿æ¢ä¸ºDifyæ–‡ä»¶IDæ•°ç»„
  5. æäº¤æŒ‰é’®æ˜¾ç¤ºä¸Šä¼ è¿›åº¦

#### `web/src/components/agents/EmptyState.tsx`
- **å˜æ›´**: è°ƒç”¨ `UserInputForm` æ—¶ä¼ å…¥ `agentConfigId` å±æ€§

#### `web/src/types/agent-chat.ts`
- **å˜æ›´**: æ–°å¢ `FileUploadResult` æ¥å£å®šä¹‰

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```
ç”¨æˆ·å¡«å†™è¡¨å•å¹¶é€‰æ‹©æ–‡ä»¶
         â†“
ç‚¹å‡»"å¼€å§‹èŠå¤©"æŒ‰é’®
         â†“
UserInputForm.handleSubmit()
  â”œâ”€ éªŒè¯è¡¨å•æ•°æ®
  â”œâ”€ æ£€æµ‹æ–‡ä»¶å­—æ®µ
  â”œâ”€ è°ƒç”¨ uploadAgentFile(s) ä¸Šä¼ åˆ°Dify
  â””â”€ è·å– Dify æ–‡ä»¶ID
         â†“
è°ƒç”¨ onSubmit(finalValues)
  - finalValues åŒ…å«æ–‡ä»¶IDè€ŒéFileå¯¹è±¡
         â†“
EmptyState.handleFormSubmit(formData)
         â†“
è°ƒç”¨ onSendMessage(message, formData)
         â†“
useAgentChat.sendMessage(text, inputs)
         â†“
agentChatService.sendAgentMessage(
  agentConfigId,
  conversationId,
  message,
  callbacks,
  inputs  // â† åŒ…å«æ–‡ä»¶ID
)
         â†“
åç«¯æ¥æ”¶ inputs å¹¶è½¬å‘ç»™Dify
         â†“
Dify ä½¿ç”¨æ–‡ä»¶IDå¤„ç†å¯¹è¯
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. å®šä¹‰è¡¨å•å­—æ®µï¼ˆDifyé…ç½®ï¼‰

```json
{
  "user_input_form": [
    {
      "variable": "document",
      "label": "ä¸Šä¼ æ–‡æ¡£",
      "type": "file",
      "required": true,
      "description": "æ”¯æŒ PDFã€Wordã€TXT æ–‡ä»¶"
    },
    {
      "variable": "images",
      "label": "ç›¸å…³å›¾ç‰‡",
      "type": "file-list",
      "required": false,
      "description": "æœ€å¤šä¸Šä¼ 5å¼ å›¾ç‰‡"
    }
  ]
}
```

### 2. ç”¨æˆ·æ“ä½œæµç¨‹

1. ç”¨æˆ·åœ¨è¡¨å•ä¸­é€‰æ‹©æ–‡ä»¶
2. æ–‡ä»¶æ˜¾ç¤ºåœ¨é¢„è§ˆåŒºåŸŸ
3. ç‚¹å‡»"å¼€å§‹èŠå¤©"æŒ‰é’®
4. æŒ‰é’®æ˜¾ç¤º"ä¸Šä¼ ä¸­..."å¹¶ç¦ç”¨
5. æ–‡ä»¶ä¸Šä¼ åˆ°DifyæœåŠ¡å™¨
6. è·å–Difyæ–‡ä»¶ID
7. å¼€å§‹å¯¹è¯ï¼Œæ–‡ä»¶IDé€šè¿‡ `inputs` å‚æ•°ä¼ é€’

### 3. æ•°æ®ä¼ é€’æ ¼å¼

```typescript
// å‰ç«¯è¡¨å•å€¼ï¼ˆæäº¤å‰ï¼‰
{
  document: File,           // Fileå¯¹è±¡
  images: [File, File]      // Fileæ•°ç»„
}

// ä¸Šä¼ åçš„æœ€ç»ˆå€¼ï¼ˆä¼ ç»™Difyï¼‰
{
  document: "upload_file_123",              // Difyæ–‡ä»¶ID
  images: ["upload_file_456", "upload_file_789"]  // Difyæ–‡ä»¶IDæ•°ç»„
}
```

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. æ–‡ä»¶ç±»å‹æ”¯æŒ
- **å•æ–‡ä»¶** (`type: 'file'`): ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
- **å¤šæ–‡ä»¶** (`type: 'file-list'`): ä¸Šä¼ å¤šä¸ªæ–‡ä»¶

### 2. ä¸Šä¼ ä½“éªŒ
- âœ… ä¸Šä¼ è¿›åº¦æç¤ºï¼ˆæŒ‰é’®æ˜¾ç¤º"ä¸Šä¼ ä¸­..."ï¼‰
- âœ… æŒ‰é’®ç¦ç”¨é˜²æ­¢é‡å¤æäº¤
- âœ… é”™è¯¯æç¤ºï¼ˆä¸Šä¼ å¤±è´¥æ—¶æ˜¾ç¤ºtoastï¼‰
- âœ… æ–‡ä»¶é¢„è§ˆå’Œåˆ é™¤åŠŸèƒ½

### 3. é”™è¯¯å¤„ç†
```typescript
try {
  // ä¸Šä¼ æ–‡ä»¶
  const uploadResult = await uploadAgentFile(agentConfigId, file);
} catch (error) {
  toast.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
  // ä¸ç»§ç»­æäº¤è¡¨å•
}
```

### 4. å¹¶è¡Œä¸Šä¼ 
å¤šæ–‡ä»¶ä¸Šä¼ ä½¿ç”¨ `Promise.all()` å®ç°å¹¶è¡Œä¸Šä¼ ï¼Œæé«˜æ•ˆç‡ï¼š

```typescript
const uploadResults = await uploadAgentFiles(agentConfigId, files);
// æ‰€æœ‰æ–‡ä»¶åŒæ—¶ä¸Šä¼ 
```

## ğŸ¨ UI æ”¹è¿›

### æŒ‰é’®çŠ¶æ€
```tsx
<Button
  onClick={handleSubmit}
  disabled={uploading}
  className="bg-orange-500 hover:bg-orange-600"
>
  {uploading ? (
    <>
      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
      ä¸Šä¼ ä¸­...
    </>
  ) : (
    'å¼€å§‹èŠå¤©'
  )}
</Button>
```

## ğŸ”§ åç«¯å¯¹æ¥

### API ç«¯ç‚¹
- **æ–‡ä»¶ä¸Šä¼ **: `POST /api/v1/agent/{agent_config_id}/upload`
- **å¯¹è¯æ¥å£**: `POST /api/v1/agent/{agent_config_id}/chat`

### è¯·æ±‚æ ¼å¼

#### æ–‡ä»¶ä¸Šä¼ 
```http
POST /api/v1/agent/{agent_config_id}/upload
Content-Type: multipart/form-data

file: <binary>
```

#### å¯¹è¯è¯·æ±‚ï¼ˆå¸¦inputsï¼‰
```json
{
  "message": "å¼€å§‹å¯¹è¯",
  "conversation_id": "conv_123",
  "inputs": {
    "document": "upload_file_123",
    "images": ["upload_file_456", "upload_file_789"]
  },
  "response_mode": "streaming"
}
```

## âœ… æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•
1. âœ… å•æ–‡ä»¶ä¸Šä¼ å¹¶æäº¤è¡¨å•
2. âœ… å¤šæ–‡ä»¶ä¸Šä¼ å¹¶æäº¤è¡¨å•
3. âœ… æ–‡ä»¶ä¸Šä¼ å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
4. âœ… ä¸Šä¼ ä¸­æŒ‰é’®ç¦ç”¨çŠ¶æ€
5. âœ… æ–‡ä»¶é¢„è§ˆå’Œåˆ é™¤åŠŸèƒ½
6. âœ… è¡¨å•éªŒè¯ï¼ˆå¿…å¡«æ–‡ä»¶å­—æ®µï¼‰

### é›†æˆæµ‹è¯•
1. âœ… å®Œæ•´æµç¨‹ï¼šé€‰æ‹©æ–‡ä»¶ â†’ ä¸Šä¼  â†’ å¯¹è¯
2. âœ… inputså‚æ•°æ­£ç¡®ä¼ é€’åˆ°åç«¯
3. âœ… Difyèƒ½æ­£ç¡®æ¥æ”¶å’Œå¤„ç†æ–‡ä»¶

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. Agenté…ç½®ID
- `UserInputForm` ç°åœ¨éœ€è¦ `agentConfigId` å±æ€§
- æ‰€æœ‰ä½¿ç”¨è¯¥ç»„ä»¶çš„åœ°æ–¹éƒ½éœ€è¦ä¼ å…¥è¯¥å±æ€§

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- é»˜è®¤æœ€å¤§æ–‡ä»¶å¤§å°: 10MB
- å¯åœ¨ `UserInputForm.tsx` ä¸­è°ƒæ•´ `maxSize` å˜é‡

### 3. æ–‡ä»¶ç±»å‹éªŒè¯
- ç”± Dify æœåŠ¡å™¨ç«¯å¤„ç†
- å‰ç«¯å¯é€šè¿‡ `accept` å±æ€§é™åˆ¶é€‰æ‹©

### 4. é”™è¯¯å¤„ç†
- ä¸Šä¼ å¤±è´¥ä¼šæ˜¾ç¤ºtoastæç¤º
- ä¸Šä¼ å¤±è´¥ä¸ä¼šæäº¤è¡¨å•
- ç”¨æˆ·å¯ä»¥é‡æ–°å°è¯•ä¸Šä¼ 

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### ä¼˜å…ˆçº§1ï¼ˆå»ºè®®ï¼‰
- [ ] æ·»åŠ ä¸Šä¼ è¿›åº¦æ¡æ˜¾ç¤º
- [ ] æ”¯æŒæ–‡ä»¶å¤§å°å’Œç±»å‹çš„å‰ç«¯éªŒè¯
- [ ] æ·»åŠ æ–‡ä»¶ä¸Šä¼ å–æ¶ˆåŠŸèƒ½

### ä¼˜å…ˆçº§2ï¼ˆå¯é€‰ï¼‰
- [ ] æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- [ ] æ”¯æŒæ–‡ä»¶ç¼©ç•¥å›¾é¢„è§ˆï¼ˆå›¾ç‰‡ï¼‰
- [ ] æ‰¹é‡æ–‡ä»¶é€‰æ‹©ä¼˜åŒ–

### ä¼˜å…ˆçº§3ï¼ˆä¼˜åŒ–ï¼‰
- [ ] ä¸Šä¼ å¤±è´¥åçš„é‡è¯•æœºåˆ¶
- [ ] æ–‡ä»¶ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
- [ ] ä¸Šä¼ ç»Ÿè®¡å’Œæ—¥å¿—

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Agentå¯¹è¯APIæŒ‡å—](./agent-chat-api-guide.md)
- [Agenté…ç½®ç®¡ç†](./agent-config-constants.md)
- [æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½](./file-upload-readme.md)

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†Agentç³»ç»Ÿçš„å®Œæ•´æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **å‰ç«¯æœåŠ¡å±‚**: åˆ›å»ºäº†ä¸“ç”¨çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡
2. **çŠ¶æ€ç®¡ç†**: æ‰©å±•äº† useAgentChat Hook
3. **UIé›†æˆ**: åœ¨ç”¨æˆ·è¾“å…¥è¡¨å•ä¸­é›†æˆæ–‡ä»¶ä¸Šä¼ 
4. **ç±»å‹å®‰å…¨**: å®Œå–„çš„TypeScriptç±»å‹å®šä¹‰
5. **ç”¨æˆ·ä½“éªŒ**: ä¸Šä¼ è¿›åº¦æç¤ºå’Œé”™è¯¯å¤„ç†

æ‰€æœ‰ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒï¼Œä¿æŒæ•´æ´ä¸€è‡´ï¼Œæ²¡æœ‰linteré”™è¯¯ã€‚

