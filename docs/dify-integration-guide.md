# Difyé›†æˆå®Œæ•´æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†AnmeiSmarté¡¹ç›®ä¸­Difyå¤šAgentåŠŸèƒ½çš„æ¶æ„è®¾è®¡ã€å®‰å…¨å®ç°ã€ä¼˜åŒ–è¿‡ç¨‹å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#-åŠŸèƒ½æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#-æ¶æ„è®¾è®¡)
3. [å®‰å…¨å®ç°](#-å®‰å…¨å®ç°)
4. [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
5. [å¼€å‘ä½¿ç”¨](#-å¼€å‘ä½¿ç”¨)
6. [ç›‘æ§ç»´æŠ¤](#-ç›‘æ§ç»´æŠ¤)
7. [æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)
8. [æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

AnmeiSmartçš„Difyé›†æˆåŠŸèƒ½æä¾›ï¼š

- **å¤šè¿æ¥ç®¡ç†**ï¼šæ”¯æŒè¿æ¥å¤šä¸ªDifyå®ä¾‹ï¼ŒAPIå¯†é’¥åŠ å¯†å­˜å‚¨
- **åº”ç”¨è‡ªåŠ¨å‘ç°**ï¼šè‡ªåŠ¨è·å–Difyä¸­çš„åº”ç”¨åˆ—è¡¨å¹¶åŒæ­¥
- **æ™ºèƒ½Agentåˆ†ç±»**ï¼šå°†åº”ç”¨åˆ†é…ç»™ä¸åŒçš„ä¸šåŠ¡åŠŸèƒ½ç±»å‹
- **åŠ¨æ€åˆ‡æ¢**ï¼šæ— éœ€é‡å¯å³å¯åˆ‡æ¢Agenté…ç½®
- **ç±»å‹åŒ–ç®¡ç†**ï¼šä¸ºä¸åŒåœºæ™¯é…ç½®ä¸“é—¨çš„Agent
- **å®‰å…¨é˜²æŠ¤**ï¼šAPIå¯†é’¥åŠ å¯†å­˜å‚¨ï¼Œå“åº”æ•°æ®æ©ç ä¿æŠ¤

### Agentç±»å‹è¯´æ˜

| Agentç±»å‹ | ç”¨é€” | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| `general_chat` | é€šç”¨èŠå¤© | æ—¥å¸¸å¯¹è¯ã€åŸºç¡€å’¨è¯¢ |
| `beauty_plan` | åŒ»ç¾æ–¹æ¡ˆç”Ÿæˆ | ä¸ªæ€§åŒ–æ–¹æ¡ˆåˆ¶å®š |
| `consultation` | å’¨è¯¢æ€»ç»“ | å¯¹è¯åˆ†æã€å†…å®¹æ€»ç»“ |
| `customer_service` | å®¢æœæ”¯æŒ | å®¢æˆ·æœåŠ¡ã€é—®é¢˜è§£ç­” |
| `medical_advice` | åŒ»ç–—å»ºè®® | ä¸“ä¸šåŒ»ç–—å’¨è¯¢ |

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Layer     â”‚    â”‚  Service Layer  â”‚    â”‚  Database Model â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - æ©ç æ˜¾ç¤º      â”‚â”€â”€â”€â”€â”‚ - ä¸šåŠ¡é€»è¾‘      â”‚â”€â”€â”€â”€â”‚ - è‡ªåŠ¨åŠ å¯†      â”‚
â”‚ - æ•°æ®éªŒè¯      â”‚    â”‚ - æ•°æ®è½¬æ¢      â”‚    â”‚ - hybrid_propertyâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Dify Integration Layer                                â”‚
â”‚                                 â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AgentManager    â”‚   â”‚ DifyServiceFactoryâ”‚  â”‚ Encryption Core â”‚  â”‚
â”‚  â”‚ - Agentç¼“å­˜     â”‚â”€â”€â”€â”‚ - ç»Ÿä¸€å®ä¾‹åˆ›å»º   â”‚  â”‚ - APIå¯†é’¥åŠ å¯†   â”‚  â”‚
â”‚  â”‚ - ç±»å‹æ˜ å°„      â”‚   â”‚ - é…ç½®ç®¡ç†       â”‚  â”‚ - å®‰å…¨è§£å¯†      â”‚  â”‚
â”‚  â”‚ - å¥åº·æ£€æŸ¥      â”‚   â”‚ - é”™è¯¯å¤„ç†       â”‚  â”‚ - å‘åå…¼å®¹      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ DifyService     â”‚   â”‚ DifyAPIClient   â”‚   â”‚DifyConnection   â”‚  â”‚
â”‚  â”‚ - æ¶ˆæ¯å¤„ç†      â”‚â”€â”€â”€â”‚ - HTTPå®¢æˆ·ç«¯    â”‚â”€â”€â”€â”‚ Service         â”‚  â”‚
â”‚  â”‚ - å¯¹è¯ç®¡ç†      â”‚   â”‚ - è¿æ¥æµ‹è¯•      â”‚   â”‚ - è¿æ¥ç®¡ç†      â”‚  â”‚
â”‚  â”‚ - é”™è¯¯é‡è¯•      â”‚   â”‚ - åº”ç”¨åŒæ­¥      â”‚   â”‚ - çŠ¶æ€åŒæ­¥      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. AIæœåŠ¡é™ç•Œä¸Šä¸‹æ–‡
```
api/app/services/ai/
â”œâ”€â”€ __init__.py              # AIæœåŠ¡æŠ½è±¡æ¥å£
â”œâ”€â”€ ai_service.py            # AIæœåŠ¡ä¸»ç±»
â”œâ”€â”€ openai_service.py        # OpenAIå®ç°
â”œâ”€â”€ dify_service.py          # Difyå®ç°
â”œâ”€â”€ dify_client.py           # Dify APIå®¢æˆ·ç«¯
â”œâ”€â”€ dify_factory.py          # DifyæœåŠ¡å·¥å‚
â”œâ”€â”€ dify_connection_service.py # Difyè¿æ¥ç®¡ç†
â””â”€â”€ agent_manager.py         # Agentç®¡ç†å™¨
```

#### 2. æ•°æ®åº“æ¨¡å‹è®¾è®¡
- **ç»Ÿä¸€å‘½å**ï¼šå…¨éƒ¨ä½¿ç”¨snake_caseå‘½åçº¦å®š
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨æšä¸¾ç±»å‹ï¼ˆSyncStatus, AgentTypeï¼‰
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
- **æ•°æ®å®Œæ•´æ€§**ï¼šå”¯ä¸€çº¦æŸå’Œæ£€æŸ¥çº¦æŸ
- **å®‰å…¨å­˜å‚¨**ï¼šAPIå¯†é’¥è‡ªåŠ¨åŠ å¯†å­˜å‚¨

#### 3. å®‰å…¨æœºåˆ¶
- **åŠ å¯†ç®—æ³•**ï¼šFernet (AES-128 + HMAC-SHA256)
- **å¯†é’¥ç®¡ç†**ï¼šPBKDF2 + å›ºå®šç›å€¼
- **å‘åå…¼å®¹**ï¼šå®‰å…¨è§£å¯†æœºåˆ¶æ”¯æŒæœªåŠ å¯†æ•°æ®
- **å“åº”ä¿æŠ¤**ï¼šAPIå“åº”ä¸­å¯†é’¥è‡ªåŠ¨æ©ç 

## ğŸ”’ å®‰å…¨å®ç°

### APIå¯†é’¥åŠ å¯†å­˜å‚¨

#### æ ¸å¿ƒåŠ å¯†ç±»
```python
class APIKeyEncryption:
    """APIå¯†é’¥åŠ å¯†è§£å¯†å·¥å…·ç±»"""
    
    def encrypt(self, plaintext: str) -> str:
        """åŠ å¯†æ˜æ–‡ï¼Œè¿”å›Base64ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸²"""
    
    def decrypt(self, encrypted_text: str) -> str:
        """è§£å¯†å¯†æ–‡ï¼Œè¿”å›æ˜æ–‡å­—ç¬¦ä¸²"""
    
    def safe_decrypt(self, encrypted_text: str) -> str:
        """å®‰å…¨è§£å¯†ï¼Œæ”¯æŒå‘åå…¼å®¹"""
    
    def is_encrypted(self, text: str) -> bool:
        """æ£€æŸ¥æ–‡æœ¬æ˜¯å¦å·²åŠ å¯†"""
```

#### æ•°æ®åº“æ¨¡å‹é€æ˜åŠ å¯†
```python
class DifyConnection(BaseModel):
    # å­˜å‚¨åŠ å¯†çš„APIå¯†é’¥
    _encrypted_api_key = Column("api_key", Text, nullable=False)
    
    @hybrid_property
    def api_key(self) -> str:
        """è·å–è§£å¯†åçš„APIå¯†é’¥"""
        return safe_decrypt_api_key(self._encrypted_api_key)
    
    @api_key.setter
    def api_key(self, value: str) -> None:
        """è®¾ç½®APIå¯†é’¥ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰"""
        self._encrypted_api_key = encrypt_api_key(value)
```

#### å®‰å…¨ç‰¹æ€§
- âœ… **åŠ å¯†å¼ºåº¦**ï¼šAES-128 + HMAC-SHA256
- âœ… **å¯†é’¥éšæœºæ€§**ï¼šæ¯æ¬¡åŠ å¯†ç»“æœä¸åŒ
- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šHMACä¿è¯æ•°æ®æœªè¢«ç¯¡æ”¹
- âœ… **å‘åå…¼å®¹**ï¼šæ”¯æŒæœªåŠ å¯†æ•°æ®è¯»å–
- âœ… **å“åº”å®‰å…¨**ï¼šAPIå“åº”ä¸­å¯†é’¥è¢«æ©ç 
- âœ… **é”™è¯¯å¤„ç†**ï¼šè§£å¯†å¤±è´¥ä¼˜é›…é™çº§

### ç¯å¢ƒé…ç½®

#### å¯é€‰ï¼šè®¾ç½®è‡ªå®šä¹‰åŠ å¯†å¯†é’¥
```bash
# ç”Ÿæˆæ–°å¯†é’¥
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# è®¾ç½®ç¯å¢ƒå˜é‡
export ENCRYPTION_KEY="your_generated_key_here"
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœ¬åœ°Difyå®ä¾‹

```bash
# å…‹éš†Difyä»“åº“
git clone https://github.com/langgenius/dify.git
cd dify/docker

# å¯åŠ¨DifyæœåŠ¡
docker-compose up -d

# è®¿é—® http://localhost/install å®Œæˆåˆå§‹åŒ–
```

### 2. åœ¨Difyä¸­åˆ›å»ºåº”ç”¨

#### åŒ»ç¾æ–¹æ¡ˆç”ŸæˆAgent
```
åº”ç”¨ç±»å‹ï¼šAgent
åº”ç”¨åç§°ï¼šåŒ»ç¾æ–¹æ¡ˆä¸“å®¶
æè¿°ï¼šä¸“é—¨ä¸ºå®¢æˆ·åˆ¶å®šä¸ªæ€§åŒ–åŒ»ç¾æ–¹æ¡ˆçš„æ™ºèƒ½åŠ©æ‰‹

ç³»ç»Ÿæç¤ºè¯ï¼š
ä½ æ˜¯ä¸€åä¸“ä¸šçš„åŒ»ç¾é¡¾é—®åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©å®¢æˆ·åˆ¶å®šä¸ªæ€§åŒ–åŒ»ç¾æ–¹æ¡ˆã€‚

å·¥ä½œæµç¨‹ï¼š
1. æ”¶é›†ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå¹´é¾„ã€æ€§åˆ«ã€è‚¤è´¨ç­‰ï¼‰
2. äº†è§£ç¾å®¹ç›®æ ‡å’ŒæœŸæœ›æ•ˆæœ
3. è¯„ä¼°é¢„ç®—å’Œæ—¶é—´å®‰æ’
4. è¯¢é—®åŒ»ç–—å²å’Œç¦å¿Œç—‡
5. åˆ¤æ–­ä¿¡æ¯å®Œæ•´æ€§
6. ç”Ÿæˆä¸ªæ€§åŒ–æ–¹æ¡ˆ
7. æ ¹æ®åé¦ˆä¼˜åŒ–æ–¹æ¡ˆ

å¿…é¡»ç¡®ä¿æ”¶é›†åˆ°æ‰€æœ‰å¿…è¦ä¿¡æ¯æ‰èƒ½ç”Ÿæˆæ–¹æ¡ˆã€‚
```

#### é€šç”¨èŠå¤©Agent
```
åº”ç”¨ç±»å‹ï¼šAgent
åº”ç”¨åç§°ï¼šé€šç”¨åŠ©æ‰‹
æè¿°ï¼šå¤„ç†ä¸€èˆ¬æ€§å¯¹è¯å’ŒåŒ»ç¾å’¨è¯¢çš„æ™ºèƒ½åŠ©æ‰‹

ç³»ç»Ÿæç¤ºè¯ï¼š
ä½ æ˜¯å®‰ç¾æ™ºäº«çš„æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œç†Ÿæ‚‰åŒ»ç¾ç›¸å…³çŸ¥è¯†ï¼Œèƒ½å¤Ÿï¼š
1. å›ç­”åŒ»ç¾ç›¸å…³é—®é¢˜
2. æä¾›æ²»ç–—å»ºè®®
3. è§£ç­”ç”¨æˆ·ç–‘é—®
4. å¼•å¯¼ç”¨æˆ·ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½

è¯·ä¿æŒä¸“ä¸šã€å‹å¥½çš„æœåŠ¡æ€åº¦ã€‚
```

#### å’¨è¯¢æ€»ç»“Agent
```
åº”ç”¨ç±»å‹ï¼šAgent
åº”ç”¨åç§°ï¼šå’¨è¯¢æ€»ç»“ä¸“å®¶
æè¿°ï¼šåˆ†æå’Œæ€»ç»“å’¨è¯¢å†…å®¹çš„æ™ºèƒ½åŠ©æ‰‹

ç³»ç»Ÿæç¤ºè¯ï¼š
ä½ æ˜¯ä¸“ä¸šçš„å’¨è¯¢æ€»ç»“åˆ†æå¸ˆï¼Œèƒ½å¤Ÿï¼š
1. åˆ†æå’¨è¯¢å¯¹è¯å†…å®¹
2. æå–å…³é”®ä¿¡æ¯
3. ç”Ÿæˆç»“æ„åŒ–æ€»ç»“
4. è¯†åˆ«å®¢æˆ·éœ€æ±‚å’Œå…³æ³¨ç‚¹
5. æä¾›åç»­å»ºè®®

è¯·ä»¥ä¸“ä¸šã€å®¢è§‚çš„æ–¹å¼è¿›è¡Œåˆ†æã€‚
```

### 3. é…ç½®AnmeiSmarté›†æˆ

1. å¯åŠ¨AnmeiSmartæœåŠ¡ï¼š
```bash
# åç«¯
cd api
source venv/bin/activate
python run_dev.py

# å‰ç«¯
cd web
npm run dev
```

2. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ç³»ç»Ÿ
3. è¿›å…¥ **ç³»ç»Ÿè®¾ç½® > Difyç®¡ç†**
4. ç‚¹å‡» **æ·»åŠ è¿æ¥** åˆ›å»ºDifyè¿æ¥ï¼š

```
è¿æ¥åç§°ï¼šæœ¬åœ°Difyå®ä¾‹
APIåŸºç¡€URLï¼šhttp://localhost/v1
APIå¯†é’¥ï¼šapp-xxxxxxxxxxxxï¼ˆè‡ªåŠ¨åŠ å¯†å­˜å‚¨ï¼‰
æè¿°ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒçš„Difyå®ä¾‹
è®¾ä¸ºé»˜è®¤è¿æ¥ï¼šâœ…
```

5. ç‚¹å‡» **æµ‹è¯•** éªŒè¯è¿æ¥
6. ç‚¹å‡» **åŒæ­¥** è·å–åº”ç”¨åˆ—è¡¨

### 4. é…ç½®Agentæ˜ å°„

ä¸ºæ¯ä¸ªåº”ç”¨é…ç½®å¯¹åº”çš„åŠŸèƒ½ç±»å‹ï¼š

1. é€‰æ‹© **åŒ»ç¾æ–¹æ¡ˆä¸“å®¶** åº”ç”¨
2. ç‚¹å‡» **é…ç½®ä¸ºAgent**
3. è®¾ç½®ï¼š
   - Agentç±»å‹ï¼š`åŒ»ç¾æ–¹æ¡ˆç”Ÿæˆ`
   - æè¿°ï¼šä¸ºå®¢æˆ·åˆ¶å®šä¸ªæ€§åŒ–åŒ»ç¾æ–¹æ¡ˆ
   - è®¾ä¸ºè¯¥ç±»å‹é»˜è®¤Agentï¼šâœ…

## ğŸ› ï¸ å¼€å‘ä½¿ç”¨

### ç»Ÿä¸€çš„æœåŠ¡å·¥å‚

```python
from app.services.ai.dify_factory import DifyServiceFactory

# ä»AIæ¨¡å‹é…ç½®åˆ›å»ºæœåŠ¡å®ä¾‹
service = DifyServiceFactory.create_from_ai_model_config(ai_config)

# ä»è¿æ¥é…ç½®åˆ›å»ºæœåŠ¡å®ä¾‹
service = DifyServiceFactory.create_from_connection(connection, app_id)

# ä»ç¯å¢ƒé…ç½®åˆ›å»ºæœåŠ¡å®ä¾‹
service = DifyServiceFactory.create_from_env_config(env_config)
```

### Agentç®¡ç†å™¨ä½¿ç”¨

```python
from app.services.ai.agent_manager import get_agent_manager
from app.db.models.system import AgentType

# è·å–Agentç®¡ç†å™¨
agent_manager = get_agent_manager(db)

# ä½¿ç”¨åŒ»ç¾æ–¹æ¡ˆAgent
beauty_agent = agent_manager.get_agent_by_type(AgentType.BEAUTY_PLAN)
if beauty_agent:
    response = await beauty_agent.generate_response("å¸®æˆ‘åˆ¶å®šä¸€ä¸ªé¢éƒ¨ç¾å®¹æ–¹æ¡ˆ", [])

# ä½¿ç”¨é€šç”¨èŠå¤©Agent
chat_agent = agent_manager.get_agent_by_type(AgentType.GENERAL_CHAT)
if chat_agent:
    response = await chat_agent.generate_response("ä½ å¥½", [])

# æ ¹æ®åç§°ä½¿ç”¨ç‰¹å®šAgent
specific_agent = agent_manager.get_agent_by_name("åŒ»ç¾æ–¹æ¡ˆä¸“å®¶")
```

### åŒ»ç¾æ–¹æ¡ˆæœåŠ¡é›†æˆ

```python
class BeautyPlanService:
    def __init__(self, db: Session):
        self.db = db
        self.agent_manager = get_agent_manager(db)
    
    def _get_beauty_plan_agent(self):
        """è·å–åŒ»ç¾æ–¹æ¡ˆä¸“ç”¨Agent"""
        agent = self.agent_manager.get_agent_by_type(AgentType.BEAUTY_PLAN)
        if not agent:
            # é™çº§åˆ°é€šç”¨Agent
            agent = self.agent_manager.get_agent_by_type(AgentType.GENERAL_CHAT)
        return agent
    
    async def generate_plan(self, user_info: dict):
        agent = self._get_beauty_plan_agent()
        return await agent.generate_response(prompt, [])
```

### å®‰å…¨çš„APIå¯†é’¥æ“ä½œ

```python
# åˆ›å»ºè¿æ¥ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰
connection = DifyConnection(
    name="æˆ‘çš„è¿æ¥",
    api_base_url="https://api.dify.ai",
    api_key="sk-my-secret-key"  # è‡ªåŠ¨åŠ å¯†å­˜å‚¨
)
db.add(connection)
db.commit()

# è¯»å–å¯†é’¥ï¼ˆè‡ªåŠ¨è§£å¯†ï¼‰
connection = db.query(DifyConnection).first()
api_key = connection.api_key  # è‡ªåŠ¨è§£å¯†è¿”å›æ˜æ–‡

# é«˜çº§ç”¨æ³•ï¼šç›´æ¥æ“ä½œåŠ å¯†æ•°æ®
encrypted = connection.get_api_key_encrypted()
connection.set_api_key_raw(encrypted_value)
```

## ğŸ“Š ç›‘æ§ç»´æŠ¤

### æ—¥å¿—ç›‘æ§

#### å…³é”®æ—¥å¿—äº‹ä»¶
- `ä½¿ç”¨æ´¾ç”Ÿå¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œå»ºè®®è®¾ç½®ç¯å¢ƒå˜é‡ ENCRYPTION_KEY`
- `è§£å¯†å¤±è´¥ï¼Œè¿”å›åŸæ–‡ï¼ˆå¯èƒ½æ˜¯æœªåŠ å¯†æ•°æ®ï¼‰`
- `Agentå¥åº·æ£€æŸ¥å¤±è´¥`
- `Difyè¿æ¥åŒæ­¥å¤±è´¥`

#### ç›‘æ§æŒ‡æ ‡
```python
# ç›‘æ§Agentå¥åº·çŠ¶æ€
async def check_agent_health():
    agent_manager = get_agent_manager(db)
    for agent_type in AgentType:
        agent = agent_manager.get_agent_by_type(agent_type)
        if agent:
            health = await agent.health_check()
            logger.info(f"Agent {agent_type}: {'å¥åº·' if health else 'å¼‚å¸¸'}")

# ç›‘æ§è¿æ¥çŠ¶æ€
async def check_connections():
    connections = db.query(DifyConnection).filter(DifyConnection.is_active == True).all()
    for conn in connections:
        try:
            client = DifyAPIClient(conn.api_base_url, conn.api_key)
            result = await client.test_connection()
            logger.info(f"è¿æ¥ {conn.name}: {'æ­£å¸¸' if result['success'] else 'å¼‚å¸¸'}")
        except Exception as e:
            logger.error(f"è¿æ¥ {conn.name} æ£€æŸ¥å¤±è´¥: {e}")
```

### æ•°æ®å¤‡ä»½ä¸æ¢å¤

#### æŸ¥çœ‹åŠ å¯†çŠ¶æ€
```sql
-- æ£€æŸ¥å“ªäº›å¯†é’¥å·²åŠ å¯†
SELECT 
    name,
    LENGTH(api_key) as key_length,
    CASE 
        WHEN api_key LIKE 'Z0FBQUFBQm%' THEN 'å·²åŠ å¯†'
        ELSE 'æœªåŠ å¯†æˆ–æ— å¯†é’¥'
    END as encryption_status
FROM dify_connections;
```

#### æ‰‹åŠ¨åŠ å¯†å‰©ä½™æ•°æ®
```python
from app.core.encryption import get_encryption
from app.db.models.system import DifyConnection

encryption = get_encryption()

# æŸ¥æ‰¾æœªåŠ å¯†çš„è¿æ¥
for conn in db.query(DifyConnection).all():
    raw_key = conn.get_api_key_encrypted()
    if raw_key and not encryption.is_encrypted(raw_key):
        conn.api_key = raw_key  # è§¦å‘è‡ªåŠ¨åŠ å¯†
        print(f"å·²åŠ å¯†è¿æ¥ {conn.name} çš„APIå¯†é’¥")

db.commit()
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
cd api
source venv/bin/activate

# è¿è¡ŒåŠ å¯†å­˜å‚¨æµ‹è¯•
python -m pytest tests/core/test_encryption.py -v

# è¿è¡Œæ•°æ®åº“æ¨¡å‹æµ‹è¯•
python -m pytest tests/models/test_system_encryption.py -v

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
python test_dify_integration.py
```

### æµ‹è¯•è¦†ç›–

- âœ… **åŠ å¯†å·¥å…·ç±»**ï¼š23ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… **æ•°æ®åº“æ¨¡å‹**ï¼šAPIå¯†é’¥è‡ªåŠ¨åŠ å¯†/è§£å¯†
- âœ… **ç«¯åˆ°ç«¯é›†æˆ**ï¼šå®Œæ•´ä¸šåŠ¡æµç¨‹éªŒè¯
- âœ… **å®‰å…¨éªŒè¯**ï¼šåŠ å¯†å¼ºåº¦å’Œæ•°æ®ä¿æŠ¤
- âœ… **å‘åå…¼å®¹**ï¼šæœªåŠ å¯†æ•°æ®å¤„ç†

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥æµ‹è¯•å¤±è´¥
```
âŒ è¿æ¥å¤±è´¥: è¿æ¥é”™è¯¯: Connection refused
```
**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿DifyæœåŠ¡æ­£åœ¨è¿è¡Œï¼š`docker-compose ps`
- æ£€æŸ¥APIåŸºç¡€URLæ˜¯å¦æ­£ç¡®
- éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

#### 2. APIå¯†é’¥éªŒè¯å¤±è´¥
```
âŒ åŒæ­¥å¤±è´¥: 401 Unauthorized
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®ï¼ˆè‡ªåŠ¨è§£å¯†éªŒè¯ï¼‰
- ç¡®è®¤APIå¯†é’¥æœ‰è¶³å¤Ÿæƒé™
- é‡æ–°ç”ŸæˆAPIå¯†é’¥å¹¶æ›´æ–°é…ç½®

#### 3. åŠ å¯†è§£å¯†å¼‚å¸¸
```
ERROR è§£å¯†å¤±è´¥: InvalidToken
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ENCRYPTION_KEYç¯å¢ƒå˜é‡
- éªŒè¯æ•°æ®åº“ä¸­çš„åŠ å¯†æ•°æ®å®Œæ•´æ€§
- é‡æ–°åŠ å¯†æŸåçš„æ•°æ®

#### 4. Agentå¥åº·æ£€æŸ¥å¤±è´¥
```
âŒ Agentå¥åº·æ£€æŸ¥å¤±è´¥
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥Difyåº”ç”¨çŠ¶æ€
- éªŒè¯åº”ç”¨IDé…ç½®
- é‡æ–°åŒæ­¥åº”ç”¨åˆ—è¡¨

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f api/logs/app.log | grep -E "(Dify|Agent|encryption)"

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
psql -h localhost -U postgres -d anmeismart
SELECT name, sync_status, is_active FROM dify_connections;
SELECT model_name, agent_type, enabled FROM ai_model_configs WHERE provider = 'dify';
```

## ğŸ”„ æœ€ä½³å®è·µ

### 1. å®‰å…¨ç®¡ç†
- **å¯†é’¥ä¿æŠ¤**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒè®¾ç½®ç‹¬ç«‹çš„ENCRYPTION_KEY
- **æƒé™æ§åˆ¶**ï¼šé™åˆ¶APIå¯†é’¥æƒé™èŒƒå›´
- **å®šæœŸè½®æ¢**ï¼šå®šæœŸæ›´æ–°APIå¯†é’¥å’ŒåŠ å¯†å¯†é’¥
- **è®¿é—®æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ

### 2. è¿æ¥ç®¡ç†
- **ç¯å¢ƒéš”ç¦»**ï¼šä¸ºä¸åŒç¯å¢ƒé…ç½®ä¸åŒè¿æ¥
- **å¥åº·ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
- **æ•…éšœåˆ‡æ¢**ï¼šé…ç½®å¤‡ç”¨è¿æ¥
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç›‘æ§å“åº”æ—¶é—´å’ŒæˆåŠŸç‡

### 3. Agenté…ç½®
- **ç±»å‹æ˜ å°„**ï¼šä¸ºæ¯ç§ä¸šåŠ¡åœºæ™¯é…ç½®ä¸“é—¨Agent
- **é»˜è®¤ç­–ç•¥**ï¼šè®¾ç½®åˆç†çš„é»˜è®¤Agentå’Œé™çº§ç­–ç•¥
- **æç¤ºä¼˜åŒ–**ï¼šå®šæœŸä¼˜åŒ–Agentæç¤ºè¯
- **ç‰ˆæœ¬ç®¡ç†**ï¼šè®°å½•Agenté…ç½®å˜æ›´å†å²

### 4. ç›‘æ§è¿ç»´
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§Agentå“åº”æ—¶é—´å’ŒæˆåŠŸç‡
- **èµ„æºç®¡ç†**ï¼šå®šæœŸæ¸…ç†Agentç¼“å­˜
- **æ•°æ®å¤‡ä»½**ï¼šå¤‡ä»½é‡è¦é…ç½®å’Œå¯¹è¯æ•°æ®
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®ä½¿ç”¨æƒ…å†µè°ƒæ•´èµ„æºé…ç½®

### 5. å¼€å‘è§„èŒƒ
- **é”™è¯¯å¤„ç†**ï¼šå®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œå’Œå¼‚å¸¸ä¿¡æ¯
- **æµ‹è¯•è¦†ç›–**ï¼šç¼–å†™å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- **æ–‡æ¡£ç»´æŠ¤**ï¼šä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥

## ğŸ“ˆ åç»­æ‰©å±•

### è®¡åˆ’ä¸­çš„åŠŸèƒ½
- **æ€§èƒ½ç›‘æ§**ï¼šAgentå“åº”æ—¶é—´å’ŒæˆåŠŸç‡ç»Ÿè®¡
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šå®ä¾‹è‡ªåŠ¨è´Ÿè½½åˆ†é…
- **A/Bæµ‹è¯•**ï¼šä¸åŒAgenté…ç½®çš„æ•ˆæœå¯¹æ¯”
- **è‡ªåŠ¨é‡è¯•**ï¼šå¤±è´¥è¯·æ±‚è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **è´¹ç”¨è¿½è¸ª**ï¼šAPIè°ƒç”¨æˆæœ¬ç»Ÿè®¡

### æ‰©å±•å¼€å‘
- **æ–°Agentç±»å‹**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ‰©å±•Agentåˆ†ç±»
- **è‡ªå®šä¹‰é€‚é…å™¨**ï¼šæ”¯æŒå…¶ä»–AIæœåŠ¡æä¾›å•†
- **å·¥å…·å‡½æ•°**ï¼šä¸ºAgenté…ç½®ä¸“ç”¨å·¥å…·å’Œæ’ä»¶
- **å¤šæ¨¡æ€æ”¯æŒ**ï¼šå›¾ç‰‡ã€è¯­éŸ³ç­‰å¤šåª’ä½“å†…å®¹å¤„ç†

## ğŸ† æŠ€æœ¯æˆæœ

æœ¬Difyé›†æˆæ–¹æ¡ˆå®ç°äº†ï¼š

âœ… **å®Œæ•´æ¶æ„**ï¼šæ¸…æ™°çš„é™ç•Œä¸Šä¸‹æ–‡å’Œç»„ä»¶è®¾è®¡
âœ… **å®‰å…¨é˜²æŠ¤**ï¼šAPIå¯†é’¥åŠ å¯†å­˜å‚¨å’Œå“åº”æ©ç 
âœ… **ä»£ç ä¼˜åŒ–**ï¼šæ¶ˆé™¤é‡å¤ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œæé«˜è´¨é‡
âœ… **æµ‹è¯•è¦†ç›–**ï¼šå…¨é¢çš„å•å…ƒã€é›†æˆå’Œç«¯åˆ°ç«¯æµ‹è¯•
âœ… **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œæœ€ä½³å®è·µ
âœ… **ç”Ÿäº§å°±ç»ª**ï¼šé”™è¯¯å¤„ç†ã€ç›‘æ§ã€ç»´æŠ¤æœºåˆ¶å®Œå¤‡

è¯¥å®ç°ä¸ºAnmeiSmarté¡¹ç›®çš„AIåŠŸèƒ½æä¾›äº†åšå®çš„åŸºç¡€ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

*æœ€åæ›´æ–°ï¼š2024å¹´7æœˆ* 