# MVP：可治理任务中枢（Governed Task Center）

## 1. 一句话定位（给老板/评审）

我们不是“又一个聊天/智能体集合”，而是把制造业销售沟通变成**可交付的闭环**：数字人按场景接入，关键词触发路由到Agent生成“动作建议”，进入任务中心自动分配执行；绝大多数直通提效，少数敏感（价格/承诺/保密/破坏性）自动拦截并给安全改写，一键确认后再发/再执行，全程留痕可追溯“谁在何时做了什么”。

## 2. MVP目标与边界（只做能演示、能闭环、能量化）

### 2.1 MVP目标

- **提效**：把“对话里散落的信息”自动结构化为可执行任务，减少销售跨部门沟通成本与遗漏。
- **可控**：不做“逐条审批”，只做“少数风险拦截 + 默认直通”。
- **可追溯**：每个闭环都能回答：从哪来、建议了啥、依据是啥、谁做了啥、结果如何。

### 2.2 MVP不做（刻意收敛）

- 不做复杂审批流（多级会签/会审）。
- 不做复杂组织权限体系（仅场景队列）。
- 不做意图识别/大规模知识库运营（先关键词规则）。

## 3. 典型业务故事（制造业销售视角）

### 3.1 场景：经销商催货 + 承诺风控（3分钟可演示）

1) 客户：`“上周那批货怎么还没出？今天给我明确交期。”`

- 命中关键词：`催货/交期/延误/违约`
- 直通生成任务并自动分配：
  - B1 创建工单：交期核查（分派：PMC队列）
  - B3 设置SLA：2小时内给出对客交期反馈（提醒/升级）
  - C2 创建跟进任务：销售今日16:00前回客户（分派：销售队列/当前销售）

2) 客户追加：`“你保证明天一定到吗？”`

- 命中敏感：承诺类
- 触发 D2 敏感拦截任务：系统给出“安全改写建议”，一键确认后再发（避免口头承诺导致违约/赔付）。

### 3.2 场景：报价折扣（价格敏感）

客户：`“同规格便宜10%行吗？给个含税价。”`

- 触发 D2 价格敏感拦截：给“合规改写”+ “报价申请工单建议”（分派报价/财务队列，24h SLA）。

## 4. 核心概念与关系（MVP最小集）

- **数字人（Digital Human）= 场景入口**：销售-交期跟进、销售-报价、售后-质量等。
- **路由规则（Routing Rule）= 触发器**：`场景 + 关键词` → `Agent/Workflow + 动作模板（Task Template）`
- **任务中心（Task Center）= 中枢**：待办 / 风险 / 已完成
- **风控（Sensitive Guard）= 少数拦截**：仅敏感进入待确认，其余直通
- **队列（Queue）= 自动分配单位**：按场景配置默认队列与轮值/负责人

## 5. MVP固定的 5 个动作（Task Types）

> 原则：所有动作统一落在“任务模型”里，动作只是 task_type + parameters。

| 编号 | 动作             | Task Type         | 默认是否直通 | 默认分派                       |
| ---- | ---------------- | ----------------- | ------------ | ------------------------------ |
| B1   | 创建工单         | CREATE_TICKET     | 是           | 由路由模板指定（如PMC/QE/FAE） |
| B2   | 分派/转派        | ASSIGN / TRANSFER | 是           | 场景队列                       |
| B3   | SLA/提醒         | SET_SLA / REMIND  | 是           | 跟随主任务/队列                |
| C2   | 创建待跟进任务   | CREATE_FOLLOWUP   | 是           | 销售队列/当前销售              |
| D2   | 敏感内容拦截任务 | SENSITIVE_GUARD   | 否（待确认） | 场景队列（默认负责人）         |

## 6. 状态机与操作（不重，但可治理）

### 6.1 状态（States）

- 通用任务：`待处理` → `执行中（可选）` → `已完成` / `已取消`
- 仅 D2：增加 `待确认`（安全改写建议可一键确认）

### 6.2 操作（Events，不做成状态）

- 转派（change assignee/queue）
- 退回重写（回到待处理 + 原因）
- 加急（priority提升）
- 合并重复（link/merge）
- 备注（comment）

## 7. 自动分配（行业最佳实践：场景队列制）

### 7.1 组织模型（MVP）

采用 **队列（Queue）+ 轮值/默认负责人**，避免“客户Owner/复杂权限”带来的工程膨胀。

建议初始队列：

- 销售队列（Sales）
- PMC队列（计划/物控）
- 报价/财务队列（Pricing/Finance）
- FAE队列（技术支持）
- QE队列（质量）

### 7.2 分配原则（MVP）

- **优先级**：场景队列默认规则（单一来源，冲突最少）
- **可扩展（后续）**：动作子队列、客户Owner（接CRM后）

## 8. 敏感拦截 D2（默认直通 + 少数拦截的关键）

### 8.1 敏感分类表（MVP够用版）

- **价格类**：报价、折扣、金额、含税、付款条款
- **承诺类**：保证到货/交付、赔付/责任、确定时间承诺
- **保密类**：图纸/工艺参数、客户名单、内部制度、源码/密钥
- **破坏性动作类**：删除/批量、修改关键资料、触发外部系统写入

### 8.2 默认行为（MVP）

- 命中敏感 → 创建 `SENSITIVE_GUARD` 任务，状态=`待确认`
- 同时生成 **安全改写建议**（至少两版：稳妥版/方案版）
- 点击“一键确认”后：采用安全改写版本，再发送/再执行（避免盲放行）

> 备注：审批人不一定及时看到，因此 D2 任务的核心不是“审批流程”，而是“给出可直接使用的安全版本”，把确认动作压缩到最低。

## 9. 证据与审计（闭环成立的最小字段）

每个任务必须能回答：**从哪来、建议了啥、依据是啥、谁做了啥、结果如何**。

### 9.1 必备字段（建议）

- **触发来源**：digital_human_id、scene_key、conversation_id、message_id（可跳转查看）
- **建议动作**：task_type + parameters（结构化）
- **上下文证据**：引用的对话片段（MVP先做“消息引用”即可）
- **责任记录**：created_by、assigned_to、（仅D2）confirmed_by、timestamps（创建/确认/完成）
- **执行结果**：success/fail + reason + artifact_ref（如工单ID）

## 10. 页面清单（MVP信息架构）

### 10.1 任务中心（核心）

- Tabs：`待办` / `风险（仅D2）` / `已完成`
- 列表字段（MVP）：标题、类型、来源场景、优先级、SLA剩余、执行者/队列、状态、更新时间
- 详情页（MVP）：
  - 来源对话引用（可点开）
  - 建议动作（结构化参数）
  - 操作：完成/转派/退回重写/备注/加急
  - D2专属：安全改写建议 + 一键确认

### 10.2 路由规则管理（按场景配置）

按 `scene_key` 维护关键词规则：

- 关键词匹配（包含/正则/分词可后续）
- 目标 Agent/Workflow
- 任务模板（要生成哪些 task_type + 默认参数 + 默认队列）
- 命中优先级与启用状态

### 10.3 队列配置（轻量）

每个场景配置默认队列与轮值/负责人（MVP先手工维护即可）。

### 10.4 指标看板（可选但强烈建议）

- Cycle Time（任务生成→完成的中位数/分位数）
- 直通率 Straight-through Rate（无需确认即可完成的比例）
- 敏感命中率（D2占比）
- SLA达标率（按场景/队列）

## 11. 初始模板（可直接用于第一版演示）

### 11.1 场景（scene_key）

- `sales_delivery`：销售-交期跟进
- `sales_pricing`：销售-报价
- `sales_tech`：销售-技术澄清（可选）

### 11.2 关键词示例（MVP起步）

- `sales_delivery`：催货、交期、延误、延期、违约、出货、排产
- `sales_pricing`：报价、折扣、便宜、含税、发票、付款、账期、合同金额
- `sensitive_guard`（规则库）：保证、承诺、赔偿、赔付、删掉、删除、图纸、工艺参数、客户名单、源码、密钥

## 12. 验收标准（MVP必须达成）

- 能跑通“交期催货”链路：关键词命中 → B1/B3/C2自动生成并分派 → 可在任务中心完成闭环
- 能跑通“承诺敏感”链路：触发D2 → 生成安全改写建议 → 一键确认 → 发送/执行 → 留痕可追溯
- 任务中心可按待办/风险/已完成完整展示，并能跳转到来源对话/消息

## 13. 开发步骤规划（里程碑）

### M0：规格冻结（0.5–1天）

- 输出：字段表、状态机、任务类型枚举、页面低保真、3分钟演示脚本
- 冻结范围：只做 5 个动作 + D2 拦截（其余进入后续迭代）

### M1：后端骨架（2–4天）

- 数据模型（最小）：Task、TaskEvent、Queue、RoutingRule、SensitiveRule
- 服务：
  - 路由：scene + text → 命中规则 → 生成任务模板（批量创建任务）
  - 任务：创建/列表/详情/完成/转派/退回/备注
  - 风控：敏感命中 → 生成安全改写建议 → 确认后继续
- API：任务中心、规则管理、队列配置（先内部接口也可）

### M2：前端页面（2–5天）

- 任务中心：列表/筛选/详情/操作（含D2一键确认）
- 路由规则管理：按场景维护关键词与模板
- 队列配置：场景 → 默认队列/轮值负责人

### M3：与智能沟通/数字人对话打通（2–4天）

- 对话入口注入：场景选择（数字人）+ 发送消息时调用路由
- 命中后：自动创建任务并跳提示（不打断对话）
- D2确认后：采用安全改写内容发送（或触发相应动作执行）

### M4：指标与演示强化（1–2天）

- 指标最小实现：Cycle Time、直通率、敏感命中率、SLA达标率
- 演示脚本固化：交期催货 + 承诺敏感

### M5：测试与稳定性（1–3天）

- 单测：路由命中、敏感拦截、任务状态流转、自动分派
- 集成：对话触发 → 任务生成 → D2确认 → 发送/执行 → 留痕

## 14. M0冻结：接口契约与字段字典（基于现有任务模块对齐）

> 目的：让前后端“按同一张表说话”，避免字段/返回格式漂移。MVP新增能力在 M1/M2 扩展时，优先复用这些约定。

### 14.1 通用响应信封（ApiResponse）

所有任务相关接口均遵循统一响应：

- `code === 0` 表示成功，`data` 为业务数据
- `code !== 0` 表示业务/系统错误，前端由 `apiClient` 统一处理

### 14.2 任务接口（/api/v1/tasks）

#### 14.2.1 获取任务列表

- **Method**：GET
- **Path**：`/api/v1/tasks`
- **Query（M0支持）**
  - `status`：可选，`pending|assigned|in_progress|completed|cancelled`
  - `task_type`：可选，字符串
  - `priority`：可选，`low|medium|high|urgent`
  - `search`：可选，模糊匹配 title/description
  - `user_role`：可选，用于后端按角色过滤（M0沿用现有策略）
- **Response**：`ApiResponse[list[TaskResponse]]`

#### 14.2.2 获取任务详情

- **Method**：GET
- **Path**：`/api/v1/tasks/{task_id}`
- **Response**：`ApiResponse[TaskResponse]`

#### 14.2.3 创建任务

- **Method**：POST
- **Path**：`/api/v1/tasks`
- **Body**：`CreateTaskRequest`
- **Response**：`ApiResponse[TaskResponse]`

#### 14.2.4 认领任务

- **Method**：POST
- **Path**：`/api/v1/tasks/{task_id}/claim`
- **Response**：`ApiResponse[TaskResponse]`

#### 14.2.5 更新任务（状态/备注/结果）

- **Method**：PUT
- **Path**：`/api/v1/tasks/{task_id}`
- **Body**：`UpdateTaskRequest`
- **Response**：`ApiResponse[TaskResponse]`

### 14.3 字段命名约定（snake_case）

任务相关字段一律使用 **snake_case**（与后端一致），前端类型定义与展示统一遵循：

- `task_type`、`created_by`、`assigned_to`
- `related_object_type`、`related_object_id`
- `task_data`、`due_date`、`completed_at`
- `created_at`、`updated_at`

### 14.4 TaskResponse 字段字典（M0最小）

- **id**：任务ID
- **title**：任务标题
- **description**：任务描述（可空）
- **task_type**：任务类型（字符串）
- **status**：`pending|assigned|in_progress|completed|cancelled`
- **priority**：`low|medium|high|urgent`
- **created_by**：创建人（可空）
- **assigned_to**：负责人（可空）
- **assigned_at**：分配时间（可空）
- **related_object_type / related_object_id**：关联业务对象（可空）
- **task_data**：任务结构化数据（可空，JSON）
- **due_date**：截止时间（可空）
- **completed_at**：完成时间（可空）
- **result**：处理结果（可空，JSON）
- **notes**：处理备注（可空）
- **created_at / updated_at**：记录时间
